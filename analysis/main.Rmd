---
subtitle: "Vorprozessierung und Analyse"
title: "Export von Kriegsmaterial aus der Schweiz"
author: "SRF Data, Timo Grossenbacher (timo.grossenbacher@srf.ch), Marie-Louise Timcke (marie.timcke@journocode.com)"
date: "02/21/2016"
output:
  html_document:
    code_folding: show
    theme: simplex
    toc: yes
    comment: NA
    echo: TRUE
    message: FALSE
    warning: FALSE
    fig.width: 10
    toc_float: 
      collapsed: false
      smooth_scroll: false
---

```{r, echo=FALSE}
project_name <- "2017-02-kriegsmaterial"
```

---

### Vorbemerkungen

Dieses Dokument beschreibt die Vorprozessierung und explorative Analyse des Datensatzes, der Grundlage der beiden auf srf.ch veröffentlichten Artikel [Schweizer Rüstungsexporte: Sind die fetten Jahre vorbei?](http://www.srf.ch/news/schweiz/schweizer-ruestungsexporte-sind-die-fetten-jahre-vorbei) und [Sieben Infografiken zu Waffen-Exporten aus der Schweiz](http://www.srf.ch/news/schweiz/sieben-infografiken-zu-waffen-exporten-aus-der-schweiz) ist.

SRF Data legt Wert darauf, dass die Datenvorprozessierung und -Analyse nachvollzogen und überprüft werden kann. SRF Data glaubt an das Prinzip offener Daten, aber auch offener und nachvollziehbarer Methoden. Zum anderen soll es Dritten ermöglicht werden, auf dieser Vorarbeit aufzubauen und damit weitere Auswertungen oder Applikationen zu generieren.  

Die Vorprozessierung und Analyse wurde im Statistikprogramm R vorgenommen. Die Endprodukte des verwendeten Scripts sind:

* `output/export.csv`: Vollständiger, aggregierter Datensatz, der aus den einzelnen Jahresstatistiken des SECO geschaffen wird. Dieser Datensatz wird im folgenden Kapitel beschrieben. 

#### R-Script & Daten

Das zugrunde liegende Script sowie die prozessierten Daten können unter [diesem Link](http://srfdata.github.io/2017-02-kriegsmaterial/rscript.zip) heruntergeladen werden. Durch Ausführen von `preprocessing.Rmd` kann der hier beschriebene Prozess nachvollzogen und dieses Dokument generiert werden. Dabei werden Daten aus dem Ordner `input` eingelesen und Ergebnisse in den Ordner `output` geschrieben. 

#### GitHub

Der Code für die vorliegende Datenprozessierung ist auf  [http://github.com/srfdata/2017-02-kriegsmaterial](http://github.com/srfdata/2017-02-kriegsmaterial) zur freien Verwendung verfügbar. 

#### Lizenz

<a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons Lizenzvertrag" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a><br /><span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/Dataset" property="dct:title" rel="dct:type">2017-02-kriegsmaterial</span> von <a xmlns:cc="http://creativecommons.org/ns#" href="https://github.com/srfdata/2017-02-kriegsmaterial" property="cc:attributionName" rel="cc:attributionURL">SRF Data</a> ist lizenziert unter einer <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Namensnennung - Weitergabe unter gleichen Bedingungen 4.0 International Lizenz</a>.

#### Weitere Projekte

Code & Daten von [SRF Data](http://srf.ch/data) sind unter [http://srfdata.github.io](http://srfdata.github.io) verfügbar.

#### Haftungsausschluss

Die veröffentlichten Informationen sind sorgfältig zusammengestellt, erheben aber keinen Anspruch auf Aktualität, Vollständigkeit oder Richtigkeit. Es wird keine Haftung übernommen für Schäden, die  durch die Verwendung dieses Scripts oder der daraus gezogenen Informationen entstehen. Dies gilt ebenfalls für Inhalte Dritter, die über dieses Angebot zugänglich sind. 

### Datenbeschreibung `export.csv`

| Attribut | Typ | Beschreibung |
|-------|------|---------|
| Land | String | Land, in das die Güter exportiert werden. |
| Jahr | Integer  | Jahr, in dem die Güter exportiert wurden. |
| Kategorie | String |  Kategorie der ausgeführten Güter, siehe unten. |
| Wert  |  Integer | Wert der Güter in Schweizer Franken. |

#### Originalquelle 

Alle Originalstatistiken seit 2000 sind auf [der Website des SECO](https://www.seco.admin.ch/seco/de/home/Aussenwirtschaftspolitik_Wirtschaftliche_Zusammenarbeit/Wirtschaftsbeziehungen/exportkontrollen-und-sanktionen/ruestungskontrolle-und-ruestungskontrollpolitik--bwrp-/zahlen-und-statistiken0.html) abrufbar.

Es wurde jeweils die Datei "Ausfuhren nach Kategorie pro Endempfängerstaat" verwendet. 

Vom SECO wurden SRF Data, wo vorhanden, Excel-Dateien zur Verfügung gestellt. Wo nicht, wurden die vorhandenen PDF-Dateien in einem mehrstufigen Prozess maschinenlesbar gemacht und darauf in die Ursprungsdatei `input/2000-2016.xlsx` überführt. 

####  Was steht hinter den Kategoriekürzeln? 

Kürzel |  Beschreibung
-------|------------------------------------------------------------------------------------------------
  KM1  |  Hand- und Faustfeuerwaffen jeglichen Kalibers
  KM2  |  Waffen jeglichen Kalibers (jedoch ohne Hand- und Faustfeuerwaffen soweit hievor in KM 1 erfasst)
  KM3  |  Munition für die in KM 1, 2 oder 12 erfassten Waffen
  KM4  |  Bomben, Torpedos, Raketen, Flugkörper
  KM5  |  Feuerleiteinrichtungen
  KM6  |  Panzer- und andere Landfahrzeuge
  KM7  |  Tränengase u.a. Reizstoffe
  KM8  |  Militärische Explosiv-, Brenn- und Treibstoffe
  KM10 |  Bemannte und unbemannte Luftfahrzeuge inkl. entsprechende Triebwerke
  KM16 |  Schmiedestücke, Gussstücke und andere unfertige Erzeugnisse
Andere |  KM9, KM11-KM15, KM17-KM22, Kryogenische (Tieftemperatur-) und supraleitende Ausrüstung (KM20), ansonsten Software, Strahlenwaffen, Kriegsschiffe...

### Vorbereitungen

```{r preparations, echo=FALSE}
detach_all_packages <- function() {
  basic_packages_blank <-  c("stats",
                             "graphics",
                             "grDevices",
                             "utils",
                             "datasets",
                             "methods",
                             "base")
  basic_packages <- paste("package:", basic_packages_blank, sep = "")

  package_list <- search()[
    ifelse(unlist(gregexpr("package:", search())) == 1, TRUE, FALSE)]

  package_list <- setdiff(package_list, basic_packages)

  if (length(package_list) > 0)  for (package in package_list) {
    detach(package, character.only = TRUE, unload = TRUE)
    print(paste("package ", package, " detached", sep = ""))
  }
}

detach_all_packages()

rm(list = ls(all.names = TRUE))
# nolint start
# Hier Arbeitsverzeichnis anpassen!
path_to_wd <- switch(EXPR = system2("whoami", stdout = TRUE),
                     "johndoe" = "~",
                     NULL)
# nolint end
if ( is.null(path_to_wd) ) {
  print("WARNING: No working directory specified for current user")
} else {
  setwd(path_to_wd)
}
```

### Packages definieren

```{r define packages}

cat("
library(dplyr)
library(tidyr)
library(ggplot2)
library(readxl)
library(stringr)
library(scales)
library(grid)
library(reshape)
library(rgdal)
library(countrycode)",
file = "manifest.R")

package_date <- "2018-09-01"

```

### Packages installieren

```{r install packages}
if (!require(checkpoint)) {
  if (!require(devtools)) {
    install.packages("devtools", repos = "http://cran.us.r-project.org")
    require(devtools)
  }
  devtools::install_github("checkpoint",
                           username = "RevolutionAnalytics",
                           ref = "v0.3.2",
                           repos = "http://cran.us.r-project.org")
  require(checkpoint)
}
# nolint start
if (!dir.exists("~/.checkpoint")) {
  dir.create("~/.checkpoint")
}
# nolint end
checkpoint(snapshotDate = package_date,
           project = path_to_wd,
           verbose = T,
           scanForPackages = T,
           use.knitr = F)
rm(package_date)
```


### Packages laden

```{r load packages}
source("manifest.R")
unlink("manifest.R")
sessionInfo()
```


### Vorprozessierung

#### Daten reinladen und typisieren

```{r load data}
# 2000 - 2017

#setwd("/Users/MarieLou/SRF/1601-arms-exports/preprocessing")

# Alle Exceltabellen liegen aufsteigend in einer Arbeitsmappe, so dass sheet1 = 2000, sheet2 = 2001 usw
# lade alle sheets der Arbeitsmappe als data frames in eine Liste sheets
sheets <- list()
for(i in 1:18){
 sheets[[i]] <- read_excel("input/2000-2017.xlsx", sheet = i)
 k <- c(2000:2017)
 sheets[[i]]$Jahr <- k[i]
}
# Liste "sheets" enthält nun einzelne data frames, wobei sheets[[1]]= 2000, sheets[[2]]= 2001 usw. 

# einzelne dataframes zu einem einzigen frame mergen und durch leere Spalten in den Ausgangsdaten erzeugte NA's durch Nullen ersetzen
export <- do.call(rbind.data.frame, sheets)
export[is.na(export)] <- 0
rm(sheets, i ,k)
```


#### Restrukturieren

```{r restructure}
# # Daten kondensieren (breit nach lang)
export_restructured <- export %>% 
  as.data.frame() %>% 
  tidyr::gather(key = "variable", value = "value", 2:12)
rm(export)
```


#### Länder-Duplikate entfernen
Wie viele Länder gibt es? 

```{r remove duplicate countries}
laender <- arrange(export_restructured, Land) # nach Ländernamen sortieren
unique(laender$Land) # vorkommende Ländernamen anzeigen: gibt es Duplikate
length(unique(laender$Land)) # wie viele Länder gibt es insgesamt (mit Duplikaten)?
```

Manuell umschreiben

```{r}
export_restructured$Land[export_restructured$Land == "Aegypten / Egypte"|export_restructured$Land == "Aegypten"] <- "Ägypten"
export_restructured$Land[export_restructured$Land == "Andorra "] <- "Andorra"
export_restructured$Land[export_restructured$Land == "Arab. Emirate / Emirats Arabes"|export_restructured$Land == "Arabische Emirate"] <- "Vereinigte Arabische Emirate"
export_restructured$Land[export_restructured$Land == "Argentinien / Argentine"] <- "Argentinien"
export_restructured$Land[export_restructured$Land == "Australien / Australie"] <- "Australien"
export_restructured$Land[export_restructured$Land == "Bahrein"|export_restructured$Land =="Bahrein / Bahrein"] <- "Bahrain"
export_restructured$Land[export_restructured$Land == "Belgien "|export_restructured$Land =="Belgien / Belgique"] <- "Belgien"
export_restructured$Land[export_restructured$Land == "Benin "|export_restructured$Land == "Benin /Benin"|export_restructured$Land == "Benin / Bénin"] <- "Benin"
export_restructured$Land[export_restructured$Land == "Bosnien / Bosnie"|export_restructured$Land == "Bosnien"|export_restructured$Land == "Bosnien und Herzeg."] <- "Bosnien-Herzegowina"
export_restructured$Land[export_restructured$Land == "Botswana / Botswana"|export_restructured$Land == "Botwana"] <- "Botswana"
export_restructured$Land[export_restructured$Land == "Brasilien / Brésil"] <- "Brasilien"
export_restructured$Land[export_restructured$Land == "Bangladesh"] <- "Bangladesch"
export_restructured$Land[export_restructured$Land == "Brunei /Brunei"|export_restructured$Land == "Brunel"] <- "Brunei"
export_restructured$Land[export_restructured$Land == "Bulgarien / Bulgaarie"|export_restructured$Land == "Bulgarien / Bulgarie"] <- "Bulgarien"
export_restructured$Land[export_restructured$Land == "Burkina Fasso / Burkina Faso"|export_restructured$Land == "Burkin Fasso"|export_restructured$Land == "Burkina Fasso"] <- "Burkina Faso"
export_restructured$Land[export_restructured$Land == "Buthan / Bouthan"|export_restructured$Land =="Buthan"] <- "Bhutan"
export_restructured$Land[export_restructured$Land == "Chile / Chili"] <- "Chile"
export_restructured$Land[export_restructured$Land == "Costa Rica / Costa Rica"] <- "Costa Rica"
export_restructured$Land[export_restructured$Land == "Dänemark / Danemark"] <- "Dänemark"
export_restructured$Land[export_restructured$Land == "Deutschland / Allemagne"] <- "Deutschland"
export_restructured$Land[export_restructured$Land == "Dom. Rep. / Rep Dom."|export_restructured$Land == "Dom Rep"|export_restructured$Land == "Dominika Rep."] <- "Dominikanische Republik"
export_restructured$Land[export_restructured$Land == "Elfenbeinküste\r\n"] <- "Elfenbeinküste"
export_restructured$Land[export_restructured$Land == "Estland / Estonie"] <- "Estland"
export_restructured$Land[export_restructured$Land == "Finnland / Finlande"|export_restructured$Land == "Finnland "|export_restructured$Land == "Finnnland / Finiande"|export_restructured$Land == "Finnnland"] <- "Finnland"
export_restructured$Land[export_restructured$Land == "Frankreich "|export_restructured$Land == "Frankreich / France"] <- "Frankreich"
export_restructured$Land[export_restructured$Land == "Franz Polynesien"] <- "Französisch-Polynesien"
export_restructured$Land[export_restructured$Land == "Großbritannien"|export_restructured$Land == "Gossbritannien"|export_restructured$Land == "Gr. Britannien / Royaume Uni"] <- "Grossbritannien"
export_restructured$Land[export_restructured$Land == "Griechenland / Grece"|export_restructured$Land == "Griechenland / Grèce"] <- "Griechenland"
export_restructured$Land[export_restructured$Land == "Hongkong"|export_restructured$Land == "Hongkong / Hong Kong"] <- "Hong-Kong"
export_restructured$Land[export_restructured$Land == "Indien / Inde"] <- "Indien"
export_restructured$Land[export_restructured$Land == "Indonesien / Indonésie"|export_restructured$Land == "Indonesien / Indonesie"] <- "Indonesien"
export_restructured$Land[export_restructured$Land == "Irland / Irlande"] <- "Irland"
export_restructured$Land[export_restructured$Land == "Island "|export_restructured$Land == "Island / Islande"] <- "Island"
export_restructured$Land[export_restructured$Land == "Italien / Italie"] <- "Italien"
export_restructured$Land[export_restructured$Land == "Japan /Japon"] <- "Japan"
export_restructured$Land[export_restructured$Land == "Jordanien / Jordanie"] <- "Jordanien"
export_restructured$Land[export_restructured$Land == "Kamerun "|export_restructured$Land == "Kamerun / Cameroune"] <- "Kamerun"
export_restructured$Land[export_restructured$Land == "Kanada / Canada"|export_restructured$Land == "Kanada "] <- "Kanada"
export_restructured$Land[export_restructured$Land == "Kasachstan / Kzakhstan"] <- "Kasachstan"
export_restructured$Land[export_restructured$Land == "Kenia / Kenya"] <- "Kenia"
export_restructured$Land[export_restructured$Land == "Korea (Süd) "|export_restructured$Land == "Korea (Süd) / Corée du Sud"|export_restructured$Land == "Korea (Süd) / Corte du Sud"|export_restructured$Land == "Korea (Süd)"|export_restructured$Land == "Süd Korea"] <- "Südkorea"
export_restructured$Land[export_restructured$Land == "Kroatien / Croatie"] <- "Kroatien"
export_restructured$Land[export_restructured$Land == "Kuwait / Kowe'it"|export_restructured$Land == "Kuwait / Koweït"|export_restructured$Land == "Kuwait "] <- "Kuwait"
export_restructured$Land[export_restructured$Land == "Lettland / Letonie"|export_restructured$Land == "Lettland "] <- "Lettland"
export_restructured$Land[export_restructured$Land == "Libanon / Liban"|export_restructured$Land == "Lebanon"] <- "Libanon"
export_restructured$Land[export_restructured$Land == "Libyen / Libye"] <- "Libyen"
export_restructured$Land[export_restructured$Land == "Litauen / Lituanie"] <- "Litauen"
export_restructured$Land[export_restructured$Land == "Luxemburg / Luxembourg"] <- "Luxemburg"
export_restructured$Land[export_restructured$Land == "Macau / Macau"|export_restructured$Land == "Macao"] <- "Macau"
export_restructured$Land[export_restructured$Land == "Malaysia / Malaisie"] <- "Malaysia"
export_restructured$Land[export_restructured$Land == "Malta / Malte"] <- "Malta"
export_restructured$Land[export_restructured$Land == "Namibia / Namibie"] <- "Namibia"
export_restructured$Land[export_restructured$Land == "Neuseeland / Nvl. Zelande"|export_restructured$Land == "Neuseeland / Nouvelle Zélande"] <- "Neuseeland"
export_restructured$Land[export_restructured$Land == "Niederlände"|export_restructured$Land == "Niederlande / Pays-Bas"|export_restructured$Land == "Niederlände / Pays-Bas"] <- "Niederlande"
export_restructured$Land[export_restructured$Land == "Niger / Niger"] <- "Niger"
export_restructured$Land[export_restructured$Land == "Norwegen / Norvege"|export_restructured$Land == "Norwegen / Norvège"] <- "Norwegen"
export_restructured$Land[export_restructured$Land == "Oman / Oman"] <- "Oman"
export_restructured$Land[export_restructured$Land == "Österreich / Autriche"] <- "Österreich"
export_restructured$Land[export_restructured$Land == "Pakistan / Pakistan"] <- "Pakistan"
export_restructured$Land[export_restructured$Land == "Peru / Pérou"] <- "Peru"
export_restructured$Land[export_restructured$Land == "Philippinen / Philipinnes"] <- "Philippinen"
export_restructured$Land[export_restructured$Land == "Polen / Pologne"] <- "Polen"
export_restructured$Land[export_restructured$Land == "Portugal / Portugal"] <- "Portugal"
export_restructured$Land[export_restructured$Land == "Rumänien / Roumanie"] <- "Rumänien"
export_restructured$Land[export_restructured$Land == "Russland / Russie"] <- "Russland"
export_restructured$Land[export_restructured$Land == "San Marino / St Marin"] <- "San Marino"
export_restructured$Land[export_restructured$Land == "Saudi Arabien"|export_restructured$Land == "Saudi Arabien / Arab. Saoudite"|export_restructured$Land == "Saudi Arabien /Arab. Saoudite"|export_restructured$Land == "Saudi Arabien "] <- "Saudi-Arabien"
export_restructured$Land[export_restructured$Land == "Schweden / Suade"|export_restructured$Land == "Schweden / Suède" ] <- "Schweden"
export_restructured$Land[export_restructured$Land == "Singapur / Singapour"] <- "Singapur"
export_restructured$Land[export_restructured$Land == "Slowakai / Slovaquie"|export_restructured$Land == "Slowakai"] <- "Slowakei"
export_restructured$Land[export_restructured$Land == "Slowenien / Slovenie"] <- "Slowenien"
export_restructured$Land[export_restructured$Land == "Spanien / Espagne"] <- "Spanien"
export_restructured$Land[export_restructured$Land == "Südafrika / Afrique du Sud"] <- "Südafrika"
export_restructured$Land[export_restructured$Land == "Thailand / Thailande"] <- "Thailand"
export_restructured$Land[export_restructured$Land == "Tschechien / Rep. Tcheque"|export_restructured$Land == "Tschechien / Rép. Tchèque"] <- "Tschechien"
export_restructured$Land[export_restructured$Land == "Tunesien / Tunisie"] <- "Tunesien"
export_restructured$Land[export_restructured$Land == "Türkei / Turquie"|export_restructured$Land == "Türkei "] <- "Türkei"
export_restructured$Land[export_restructured$Land == "Ungarn / Hongrie"] <- "Ungarn"
export_restructured$Land[export_restructured$Land == "Uruguay / Uruguay"] <- "Uruguay"
export_restructured$Land[export_restructured$Land == "USA "|export_restructured$Land == "USA / Etats-Unis" | export_restructured$Land == "U.S.A"] <- "USA"
export_restructured$Land[export_restructured$Land == "Zypern / Chypre"] <- "Zypern"
export_restructured$Land[export_restructured$Land == "Antillen, Niederl."] <- "Niederländische Antillen"
export_restructured$Land[export_restructured$Land == "Kirgistan / Kirghistan"|export_restructured$Land == "Kirgistan"] <- "Kirgisistan"
export_restructured$Land[export_restructured$Land == "Ecuador "] <- "Ecuador"
export_restructured$Land[export_restructured$Land == "Madagascar"] <- "Madagaskar"
export_restructured$Land[export_restructured$Land == "Salvador"] <- "El Salvador"
export_restructured$Land[export_restructured$Land == "Surinam"] <- "Suriname"
```

Wie viele Länder gibt es jetzt noch? 

```{r check number of countries}
length(unique(export_restructured$Land)) # Anzahl Länder
sort(unique(export_restructured$Land)) # Überblick über die Ländernamen, um eventuell übersehene Duplikate aufzuspüren
```

129 verschiedene Länder wurden im Zeitraum 2000 bis 2017 beliefert

#### Output als CSV

```{r output export_restructured}
export_csv <- export_restructured %>% dplyr::rename(Kategorie = variable, Wert = value)
write.csv(export_csv, file = "output/export_2017.csv", fileEncoding = "utf-8", row.names = F)
rm(export_csv)
```

#### SRF Theme für die Grafiken vorbereiten

```{r define ggplot theme}
theme_srf <- function(base_size = 10, base_family = "Arial", ...) {
  theme_bw() +
    theme(
      title = element_text(size = 16, family = base_family, face = "bold"), 
      text = element_text(color = "#555555", family = base_family),
      legend.text = element_text(size = 12), 
      legend.title = element_text(size = 14),
      legend.margin = unit(0, "cm"),
      axis.line = element_blank(),
      legend.box = "vertical", 
      panel.border = element_blank(),
      plot.background = element_rect(fill = "#f5f5f2"), 
      panel.background = element_rect(fill = "#f5f5f2"), 
      legend.background = element_rect(fill = "#f5f5f2"),  
      legend.key = element_blank(),
      legend.key.width = unit(c(0.7), units = "cm"),
      legend.key.height = unit(c(0.5), units = "cm"),
      panel.grid.minor = element_blank(), 
      panel.margin = unit(c(0.4,0.4,0.4,0.4), units = "mm"),
      plot.margin = unit(c(0.9,0.9,0.9,0.9), "cm"),
      axis.title.y = element_text(size = 14, vjust = 2),
      axis.title.x = element_text(size = 14, vjust = -1),
      axis.text = element_text(size = 12),
      complete = TRUE,
      ...
    )
}

# kleineres srf theme
theme_srf_small <- function(base_size = 8, base_family = "Arial", ...) {
  theme_srf() +
    theme(
      title = element_text(size = 14, family = base_family, face = "bold"), 
      text = element_text(color = "#555555", family = base_family),
      legend.text = element_text(size = 9), 
      legend.title = element_text(size = 11),
      legend.key.width = unit(c(0.7), units = "cm"),
      legend.key.height = unit(c(0.5), units = "cm"),
      panel.margin = unit(c(0.4,0.4,0.4,0.4), units = "mm"),
      plot.margin = unit(c(0.9,0.9,0.9,0.9), "cm"),
      axis.title.y = element_text(size = 12, vjust = 2),
      axis.title.x = element_text(size = 12, vjust = -1),
      axis.text = element_text(size = 11),
      ...
    )
}

sources <- function(text = "SECO", vpos = "top"){
  g = grobTree(textGrob(paste("Quelle:", text), x = ifelse(vpos == "top", 0.5, 0.955), y = ifelse(vpos == "top", 0.98, 0.08), just = ifelse(vpos == "top", "center", "right"), vjust = ifelse(vpos == "top", "top", "bottom"), gp = gpar(fontfamily = "SRG SSR Type", col = "#555555", fontsize = 14)))
  annotation_custom(g)
}

sources_small <- function(text = "SECO", vpos = "top"){
  g = grobTree(textGrob(paste("Quelle:", text), x = ifelse(vpos == "top", 0.5, 0.955), y = ifelse(vpos == "top", 0.98, 0.08), just = ifelse(vpos == "top", "center", "right"), vjust = ifelse(vpos == "top", "top", "bottom"), gp = gpar(fontfamily = "Arial", col = "#555555", fontsize = 10)))
  annotation_custom(g)
}
```

### Analyse

#### Exportvolumen nach Zeit 

Wie hat sich das Exportvolumen über die Jahre verändert?

```{r export volume change, fig.height = 8}
Export <- export_restructured %>% 
   group_by(Jahr) %>% # ordnet die Daten nach Jahren an
   dplyr::summarise(value = sum(value)) # fasst Exportvolumen nach Jahren zusammen

Export # Zeigt Exportvolumen gesamt pro Jahr

# add total export value for JAN-JUN 2018 
newData<-data.frame("Jahr"=2018, "value"=205188633)
Export<-rbind(Export, newData)

sum(Export$value) # Summe aller Exporte der letzten 15 Jahre
sum(Export$value[Export$Jahr >= 2010]) # Summe aller Exporter der letzten 5 Jahre
sum(Export$value[Export$Jahr >= 2010])/sum(Export$value)*100 # Anteil der Exporte der letzten 5 Jahre am Gesamtexportvolumen

# Barplot des Gesamtvolumens nach Jahr
volmio_1 <- Export$value/1000000 # Exportvolumen in Millionen
ExportBar <- ggplot(data = Export, aes(x = Jahr, y = volmio_1)) + 
   geom_bar(stat = "identity", fill = "#94928d") + 
   xlab("Jahr") +
   scale_y_continuous(name="Exportvolumen in Mio. CHF", labels=function(x) format(x, big.mark = "'", scientific = FALSE))+
   theme_srf_small()+
   sources_small("SECO", vpos = "top") +
   ggtitle(paste("Exportvolumen")) +
   scale_x_continuous(breaks=seq(2000,2018,1),labels=abs(seq(2000,2018,1))) + 
   theme(axis.text.x = element_text(angle=0, vjust=0.5))

ExportBar

# speichern der Grafik als png im Ordner output
#png(filename = "output/ExportvolumenNachJahr.png", width = 624, height = 468)
#ExportBar + theme_srf() + sources("SECO", vpos = "top")+theme(axis.text.x = element_text(angle=-30, #vjust=0.5))
#dev.off()
rm(ExportBar, volmio_1)
```

#### Empfängerländer

An wie viele verschiedene Länder hat die Schweiz pro Jahr Kriegsgüter exportiert?

```{r receiving countries, fig.height = 7}
# Berechne Anzahl der belieferten Länder pro Jahr

AnzahlLaender <- list() # leere Zielliste
for(i in 2000:2017){ # Schleife über die Daten aus den Jahren 2000 bis 2014
AnzahlLaender[[i]] <- length(unique(export_restructured[export_restructured$Jahr==i,]$Land)) # Anzahl der Länder werden nach Jahr berechnet und das Ergebnis in der Liste abgelegt
}

Anzahldat <- do.call(rbind.data.frame, AnzahlLaender[2000:2017]) # Anzahlliste zu data frame machen
names(Anzahldat) <- c("Anzahl") # Namen der Anzahlspalte ändern
Anzahldat$Jahr <- 2000:2017 # Zweite Spalte mit Jahreszahlen hinzufügen
Anzahldat # data frame mit Anzahl belieferter Länder pro Jahr

# Barplot der Azahl belieferter Länder nach Jahr
AnzahlLaenderBar <- ggplot(data = Anzahldat, aes(x = Jahr, y = Anzahl)) + 
   geom_bar(stat = "identity") + 
   xlab("Jahr") +
   scale_y_continuous(name="Länderanzahl")+
   theme_srf_small()+
   sources_small("SECO", vpos = "top") +
   geom_text(aes(label = Anzahl, vjust=-0.2), size = 4)+
   ggtitle(paste("Belieferte Länder nach Jahr")) +
   scale_x_continuous(breaks=seq(2000,2017,1),labels=abs(seq(2000,2017,1))) + 
   theme(axis.text.x = element_text(angle=0, vjust=0.5))
   
AnzahlLaenderBar

# speichern der Grafik als png im Ordner output
#png(filename = "output/AnzahlLaender.png", width = 624, height = 468)
#AnzahlLaenderBar + theme_srf() 
#dev.off()

# Durchschnitt belieferter Länder pro Jahr
sum(Anzahldat$Anzahl)/length(Anzahldat$Anzahl)
rm(Anzahldat, laender, AnzahlLaender, AnzahlLaenderBar, i)
```

##### Stammkunden

Welche Länder wurden in jedem Jahr aufs Neue beliefert?

```{r regular customers}
Stammlaender <- list() # leere Zielliste
for(i in 2000:2017){
  Stammlaender[[i]] <- unique(export_restructured[export_restructured$Jahr==i,]$Land) # Länder werden nach Jahren sortiert und in der Liste abgelegt
}

Stamm <- Reduce(intersect, Stammlaender[2000:2017]) # Vektor der Länder, die in jedem Jahr beliefert wurden

length(Stamm) # Anzahl der Länder, die in jedem Jahr unter den Belieferten zu finden sind
rm(Stamm, Stammlaender)
```

Rüstungsunternehmen aus der Schweiz belieferten im Zeitraum von 2000 bis 2017 129 verschiedene Länder mit Kriegsgütern, im Schnitt jährlich 67 Länder. Es gibt 27 Stammländer, an die jedes Jahr geliefert wurde.  

Mit welchen 10 Ländern wird am meisten gehandelt?

```{r top 10 countries, fig.height = 8}
# 2000-2017 gesamt
# erstelle data frame, der nur die zehn Länder mit den höchsten Exportvolumen des Zeitabschnitts enthält  

Top10 <- export_restructured %>% 
   group_by(Land) %>%
   summarize(value = sum(value)) %>%
   arrange(desc(value)) %>%
   slice(1:10)

# filtere alle Informationen nur dieser zehn Länder aus den Gesamtdaten heraus
 laenderSummen10Sortiert <- export_restructured  %>%
                            filter(Land %in% Top10$Land) %>%
                            group_by(Land, variable) %>% # ordne auch nach Kategorie
                            summarize(value = sum(value)) %>% 
                            ungroup()
 
# definiere eine Funktion, die in filter() als "alles, außer" genutzt werden kann
'%!in%' <- function(x,y)!('%in%'(x,y)) 
 
# definiere data frame, der alle anderen Länder enthält
laenderAndere <- export_restructured %>%
                filter(Land %!in% Top10$Land) %>%
                group_by(variable) %>%
                summarize(value = sum(value)) %>%
                arrange(desc(value)) %>% 
                select(variable, value) %>% 
                ungroup()
laenderAndere$Land <- c("Andere") # benenne die Länder in "Andere" um

# Reihenfolge ändern
laenderAndere <- laenderAndere %>% select(Land, variable, value)

# binde die data frames zu einem 
df1 <- laenderSummen10Sortiert[order(match(laenderSummen10Sortiert$Land, Top10$Land)), ]
laenderSummen10SortiertForBar <- rbind(df1,  laenderAndere) 

# barplot des Exportvolumens der zehn Länder mit dem größten Exportvolumen für das Zeitintervall sowie der Summe der Exportvolumen aller anderen Länder eingefärbt nach Kategorien
valmio_2 <- laenderSummen10SortiertForBar$value/1000000000 # Exportvolumen in Millionen
laenderSummenBar <- ggplot(data = laenderSummen10SortiertForBar, aes(x = factor(Land, levels=unique(as.character(Land)) ), y = valmio_2, fill = factor(variable), order = variable)) + 
   geom_bar(stat = "identity") +
   scale_y_continuous(name="Exportvolumen in Mrd. CHF", labels=function(x) format(x, big.mark = "'", scientific = FALSE))+
   theme_srf_small()+
   sources_small("SECO", vpos = "top") +
   ggtitle("Exportvolumen nach Land und Kategorie\n 2000-2016") +
   theme(axis.text.x = element_text(angle=40, vjust=1, hjust=1, size=10))+
   guides(fill=guide_legend(title="Kategorie", reverse = T))+
   xlab("Land")

laenderSummenBar 
# speichern der Grafik als png im Ordner output   
#png(filename = "output/ExportvolumenNachJahrTop5.png", width = 624, height = 468)
#laenderSummenBar
#dev.off()

# rechne Anteile pro Land
laenderSummen10SortiertForBar_prop <- laenderSummen10SortiertForBar %>%
  group_by(Land) %>%
  mutate("sum" = sum(value)) %>%
  mutate("proportion"=value/sum)

# derselbe Barplot, Kategorien in Prozent des Exportvolumens in jedes Land
laenderSummenBar_prop <- ggplot(data = laenderSummen10SortiertForBar_prop, aes(x = factor(Land, levels=unique(as.character(Land)) ), y = proportion, fill = factor(variable), order = variable)) + 
   geom_bar(stat = "identity") +
   scale_y_continuous(name="Exportvolumen in Prozent", labels=function(x) format(x, big.mark = "'", scientific = FALSE))+
   theme_srf_small()+
   sources_small("SECO", vpos = "top") +
   ggtitle("Exportvolumen nach Land und Kategorie\n 2000-2017") +
   theme(axis.text.x = element_text(angle=40, vjust=1, hjust=1, size=10))+
   guides(fill=guide_legend(title="Kategorie", reverse = T))+
   xlab("Land")

# erstelle nach dem gleichen Muster die gleiche Grafik über eine Schleife für jedes Jahr einzeln
Top10_ <- list()
Laendersummen_ <- list()
laenderAndere_ <- list()
laenderSummen10SortiertForBar_ <- list()
plot <- list()

for(i in 2000:2017){
data <- export_restructured[export_restructured$Jahr == i,]
  
Top10_[[i]] <- data %>%
               group_by(Land) %>%
               summarize(value = sum(value)) %>%
               arrange(desc(value)) %>%
               slice(1:10) 

yearsTop10 <- as.data.frame(Top10_[[i]])
 
Laendersummen_[[i]] <- data %>%
                       dplyr::filter(Land %in% yearsTop10$Land) %>%
                       group_by(Land, variable) %>%
                       summarize(value = sum(value))%>%
                       arrange(desc(value)) %>%
                       slice(1:10) %>% 
                       ungroup()
 
 laenderAndere_[[i]] <- data %>%
                        filter(Land %!in% yearsTop10$Land) %>%
                        group_by(variable) %>%
                        summarize(value = sum(value)) %>%
                        arrange(desc(value)) %>% 
                        select(variable, value) %>% 
                        ungroup()
laenderAndere_[[i]]$Land <- c("Andere")

# Reihenfolge ändern
laenderAndere_[[i]] <- laenderAndere_[[i]] %>% select(Land, variable, value)

laenderSummen10SortiertForBar_[[i]] <- rbind( Laendersummen_[[i]][order(match( Laendersummen_[[i]]$Land, yearsTop10$Land)), ], laenderAndere_[[i]]) 

valmio_4 <- laenderSummen10SortiertForBar_[[i]]$value/1000000
plot[[i]] <- ggplot(data = laenderSummen10SortiertForBar_[[i]], aes(x = factor(Land, levels=unique(as.character(Land)) ), y = valmio_4, fill = factor(variable), order = variable)) + 
   geom_bar(stat = "identity") +
   scale_y_continuous(name="Exportvolumen in Mio. CHF", labels=function(x) format(x, big.mark = "'", scientific = FALSE))+
   theme_srf_small()+
   sources_small("SECO", vpos = "top") +
   ggtitle(paste("Exportvolumen der Top 10\n", i)) +
   theme(axis.text.x = element_text(angle=40, vjust=1, hjust=1, size=10))+
   guides(fill=guide_legend(title="Kategorie", reverse = T))+
   xlab("Land")
}

# Grafik für:
# 2000
#plot[[2000]]
# 2001
#plot[[2001]]
# 2002
#plot[[2002]]
# 2003
#plot[[2003]]
# 2004
#plot[[2004]]
# 2005
#plot[[2005]]
# 2006
# plot[[2006]]
# 2007
#plot[[2007]]
# 2008
#plot[[2008]]
# 2009
#plot[[2009]]
# 2010
#plot[[2010]]
# 2011
#plot[[2011]]
# 2012
#plot[[2012]]
# 2013
#plot[[2013]]
# 2014
#plot[[2014]]
# 2015
#plot[[2015]]
# 2016
#plot[[2016]]
# 2017
#plot[[2017]]
rm(Top10, df1, laenderAndere, laenderAndere_, laenderSummen10Sortiert, laenderSummen10SortiertForBar, laenderSummen10SortiertForBar_, yearsTop10, data, Laendersummen_, laenderSummenBar, plot, Top10_, valmio_2, valmio_4)

# rekategorisiere km1=km2, rechne Anteile pro Land und Jahr und zeige diese als small multiples

export_restructured_recoded<-export_restructured
export_restructured_recoded$variable <-recode(export_restructured$variable, "KM1"="KM2") #waffen jeglichen kalibers, inkl Hand- und Faustfeuerwaffen
export_restructured_recoded$variable <-recode(export_restructured_recoded$variable, "KM4"="Andere") 
export_restructured_recoded$variable <-recode(export_restructured_recoded$variable, "KM7"="Andere")
export_restructured_recoded$variable <-recode(export_restructured_recoded$variable, "KM8"="Andere")
export_restructured_recoded$variable <-recode(export_restructured_recoded$variable, "KM16"="Andere")
summary(as.factor(export_restructured_recoded$variable))

export_restructured_recoded %>%
  group_by(variable)%>%
  summarize(value=sum(value))%>%
  arrange(value)

cntryMaterial_prop <- export_restructured_recoded %>%
  group_by(Land, Jahr, variable) %>%
  summarize(value=sum(value)) %>%
  group_by(Land, Jahr) %>%
  mutate("sum" = sum(value)) %>%
  group_by(variable) %>%
  mutate("proportion"=100*value/sum)

ggplot(cntryMaterial_prop, aes(x=Jahr, y=proportion, group=variable, fill=variable))+
  geom_bar(stat="identity") +
  facet_wrap(~factor(Land))+
  theme(axis.text.x = element_text(angle = 45))
ggsave("weaponXtime_country.pdf", width=12)

# visualize particuar countries
countries<-c("Deutschland", "USA", "Vereinigte Arabische Emirate", "Grossbritannien", "Dänemark", "Saudi-Arabien")
cntryMaterial_prop$variable<-as.factor(cntryMaterial_prop$variable)
cntryMaterial_prop$Land<-as.factor(cntryMaterial_prop$Land)

#visualize as absolute values
cntryMaterial_prop <- export_restructured_recoded %>%
  group_by(Land, Jahr, variable) %>%
  summarize(value=sum(value)) %>%
  filter(Land %in% countries)
levels(cntryMaterial_prop$variable)

#relevel
cntryMaterial_prop$variable<-as.factor(cntryMaterial_prop$variable)
cntryMaterial_prop$variable <- factor(cntryMaterial_prop$variable,levels(cntryMaterial_prop$variable)[c(6,5,4,3,2,1)])

ggplot(cntryMaterial_prop,aes(x=Jahr, y=value, group=variable, fill=variable))+
  geom_bar(stat="identity")+
  facet_wrap(~factor(Land))+
  theme_minimal()

```

Die Top 10 2000-2017 sind vor allem europäische Länder sowie die USA, Saudi-Arabien und die Vereinigten Arabischen Emirate. Mit großem Abstand auf Platz 1 befindet sich Deutschland, das hauptsächlich KM6 (Panzer- und andere Landfahrzeuge) und KM3 (Munition für die in KM 1, 2 oder 12 erfassten Waffen) gekauft hat. Die Emirate und die USA fallen durch ihren überdurchschnittlichen Anteil von KM10 (Bemannte und unbemannte Luftfahrzeuge inkl. entsprechende Triebwerke) auf. 14/17 Mal befindet sich Deutschland auf Platz 1.



```{r}
# development of export to Top 10 over time
Top10time<-export_restructured %>%
  filter(Land %in% Top10$Land) %>%
  group_by(Land,Jahr) %>%
  summarise(value=sum(value))

ggplot(Top10time, aes(x=Jahr, y=value, group=Land, col=Land))+
  geom_line()

# development of export to countries over time
countryXtime<-export_restructured %>% 
   group_by(Land, Jahr) %>%
   summarize(value = sum(value)) %>%
   arrange(Jahr)
   
# linecharts as small multiples
ggplot(countryXtime, aes(x=Jahr, y=value)) +
  geom_line()+
  facet_wrap(~Land)
ggsave("exportXtime_country.pdf", width=12)
  
# visualize particuar countries
countries<-c("Deutschland", "USA", "Vereinigte Arabische Emirate", "Grossbritannien", "Dänemark", "Saudi-Arabien")
countryXtime %>% 
  filter(Land %in% countries) %>%
  ggplot(aes(x=Jahr, y=value))+
  geom_bar(stat="identity")+
  facet_wrap(~Land)+
  theme_minimal()+
  scale_y_continuous(labels=c(50000000, 10000000, 150000000, 200000000))
  ggsave("exportXtime_cntry_selection.pdf", width=12)

# visualize top 20
countryXtime %>% 
  filter(Land %in% Top20$Land) %>%
  ggplot(aes(x=Jahr, y=value))+
  geom_bar(stat="identity")+
  facet_wrap(~Land)+
  theme_minimal()
ggsave("exportXtime_cntry_selection.pdf", width=12)

# compare 2000 vs. 2017 for every export country, arrange by difference
compare0017<-export_restructured %>%
  group_by(Land, Jahr) %>%
  summarize(value=sum(value)) %>%
  filter(Jahr %in% c(2000, 2017)) %>%
  spread(key=Jahr, value=value) %>%
  mutate(diff=`2017`-`2000`) %>%
  arrange(desc(diff))

# find the largest year-over-year increase for every export country, in absolute and relative differences, arrange by difference
compareBiggest<-data.frame()
for(i in unique(countryXtime$Land)){
  countryi<-subset(countryXtime, countryXtime$Land==i)
  for(j in 1:nrow(countryi)){
    datayeari<-countryi[j,]
    yeari<-datayeari$Jahr
    datayearinext<-countryi[j+1,]
    yearinext<-datayearinext$Jahr
    valuei<-datayeari$value
    valueinext<-datayearinext$value
    ifelse(identical(countryi$value[countryi$Jahr==yearinext]-countryi$value[countryi$Jahr==yeari], numeric(0)), yoyj<-NA_real_, yoyj<-countryi$value[countryi$Jahr==yearinext]-countryi$value[countryi$Jahr==yeari])
    ifelse(identical(100*yoyj/countryi$value[countryi$Jahr==yeari],numeric(0)), yoyj_rel<-NA_real_, yoyj_rel<-100*yoyj/countryi$value[countryi$Jahr==yeari])
    rowi<-cbind("Land"=paste0(i), "Jahr1"=paste0(yeari), "Jahr2"=paste0(yearinext), "Value1"=paste0(valuei), "Value2"=paste0(valueinext), "yoy"=yoyj, "yoy_rel"=yoyj_rel)
    compareBiggest<-rbind(compareBiggest, rowi)
  }
}
compareBiggest$yoy<-as.numeric(as.character(compareBiggest$yoy))
compareBiggest$yoy_rel<-as.numeric(as.character(compareBiggest$yoy_rel))

compareBiggest_ord<-compareBiggest %>%
  arrange(desc(yoy))
write.table(compareBiggest_ord, file="yourpath/data/biggestRise.txt", sep="\t", row.names=F, quote=F)

```



Wie viel Prozent des Exportvolumens fallen auf die 5 Länder mit dem grössten Exportvolumen? 

```{r export volume top 5 contries}
# 2000 bis 2017 gesamt
laenderSummen5Sortiert <- export_restructured %>%
   group_by(Land) %>%
   summarize(value = sum(value)) %>%
   arrange(desc(value)) %>%
   slice(1:5)
 
laenderSummen5Sortiert # betrachte data frame

# Anteil der Ausfuhren an die fünf Länder mit dem größten Exportvolumen gesamt 2000-2016 am Gesamtexportvolumen
sum(laenderSummen5Sortiert$value)/sum(export_restructured$value) * 100
 
# berechne Exportsummen der Top 5 gesamt für jedes Jahr
AnteilTop5 <- list()
 for(i in 2000:2017){  
  laenderSummen5proJahr <- export_restructured[export_restructured$Jahr == i,] %>%
   group_by(Land) %>%
   summarize(value = sum(value)) %>%
   arrange(desc(value)) %>%
   slice(1:5)

AnteilTop5[[i]] <-  paste(sum(laenderSummen5proJahr$value)/sum(export_restructured[export_restructured$Jahr == i,]$value) * 100, "%") 
 }

# Merge Liste der Ergebnisse zu überscihtlicherem data frame
LAnteilTop5 <- do.call(rbind.data.frame, AnteilTop5[2000:2017]) 
names(LAnteilTop5) <- c("Anteil") # Namen der Anteilsspalte ändern
LAnteilTop5$Jahr <- 2000:2017 # Zweite Spalte mit Jahreszahlen hinzufügen

LAnteilTop5

# Barchart: Wie hat sich der Anteil der Top 5 über die Zeit verändert?
ggplot(data=LAnteilTop5, aes(x = Jahr, y = Anteil)) +
  geom_bar(stat="identity")

# Barchart: Wie hat sich das Exportvolumen der Top 5 pro Jahr verändert?
# 2000 bis 2017 gesamt
Top5 <- export_restructured  %>% 
   filter(Land %in% laenderSummen5Sortiert$Land) %>% 
   group_by(Jahr, Land) %>%
   summarize(value = sum(value))

valmio_14 <- Top5$value/1000000
Top5bar <- ggplot(data = Top5, aes(x = Jahr, y = valmio_14, fill = Land)) + 
   geom_bar(stat = "identity") + 
   scale_y_continuous(name="Exportvolumen in Mio. CHF", labels=function(x) format(x, big.mark = "'", scientific = FALSE))+
   scale_x_continuous(breaks=seq(2000,2016,1),labels=abs(seq(2000,2016,1))) + 
   theme_srf_small()+
   sources_small("SECO", vpos = "top") +
   ggtitle("Exportvolumen nach Ländern \n Top 5 2000-2016") +
   guides(fill=guide_legend(title="Länder", reverse = T))+
   xlab("Jahr")

Top5bar

# speichern der Grafik als png im Ordner output 
#png(filename = "output/Top5nachLandundJahr.png", width = 624, height = 468)
#Top5bar + theme_srf() + sources("SECO", vpos = "top")
#dev.off()
rm(laenderSummen5proJahr, laenderSummen5Sortiert, LAnteilTop5, Top5, AnteilTop5, i, Top5bar, valmio_14, valmio_2)
```

Die Top 5 2000-2016 machen fast 47% des Exportvolumens aus. Der Anteil pro Jahr unterliegt minimalen Schwankungen, ist insgesamt von 2000 auf 2014 um knapp 19% gestiegen und 2015 wieder um 12 gesunken. 

##### Weltkarte

Welche Länder hat die Schweiz im Zeitraum 2000-2016 bzw. 2017 mit Waffen beliefert? Wir zeigen sie auf einer Karte

```{r map map export countries}

# get unique country names for exports in 2017
exportCntry2017<-export_restructured %>%
  filter(Jahr==2017) %>%
  distinct(Land) %>%
  mutate(color="blue")

# get unique country names for exports anytime
exportCntryAnytime<-export_restructured %>%
  filter(!Land %in% exportCntry2017$Land) %>% # get rid of those that were exported to in 2017
  distinct(Land) %>%
  mutate(color="lightblue")

# create dataframe for map
exportCntryType<-rbind(exportCntry2017, exportCntryAnytime)

# get shapefile with German country name variable (https://www.naturalearthdata.com/downloads/110m-cultural-vectors/)
worldmap<-readOGR("input/ne_10m_admin_0_countries/ne_10m_admin_0_countries.shp")

# identify country names that are not spelled as in shapefile
exportCntryType$Land[!exportCntryType$Land %in% worldmap$NAME_DE] 

# manually rewrite
exportCntryType$Land[exportCntryType$Land == "Bosnien-Herzegowina"] <- "Bosnien und Herzegowina"
exportCntryType$Land[exportCntryType$Land == "Grossbritannien"] <- "Vereinigtes Königreich"
exportCntryType$Land[exportCntryType$Land == "Tschechische Rep."] <- "Tschechien"
exportCntryType$Land[exportCntryType$Land == "Trinidad Tobago"] <- "Trinidad und Tobago"
exportCntryType$Land[exportCntryType$Land == "Zypern"] <- "Republik Zypern"
exportCntryType$Land[exportCntryType$Land == "China"] <- "Volksrepublik China"
exportCntryType$Land[exportCntryType$Land == "Finnnland"] <- "Finnland"
exportCntryType$Land[exportCntryType$Land == "Hong-Kong"] <- "Hongkong"
exportCntryType$Land[exportCntryType$Land == "USA"] <- "Vereinigte Staaten"
exportCntryType$Land[exportCntryType$Land == "Zypern"] <- "Republik Zypern"

# special case Niederländische Antillen, until 2010. Now: Curaçao, Sint Maarten (autonomous), Bonaire, Saba, St. Eustatius (part of Netherlands)
exportCntryType[grep("Nied", exportCntryType$Land), ]
antillen<-data.frame("Land"=c("Curaçao", "Sint Maarten"), "color"=c("lightblue","lightblue"))
exportCntryType<-rbind(exportCntryType, antillen)

# get rid of unused countries
exportCntryType<-exportCntryType[-which(exportCntryType$Land=="Niederländische Antillen"),]
exportCntryType<-exportCntryType[-which(exportCntryType$Land=="Heiliger Stuhl"),] # address Heiliger Stuhl = Vatikan in a footnote

# augment color vector with the countries Switzerland did not export to
exportCntryType_augm<-merge(exportCntryType, worldmap, by.x="Land", by.y="NAME_DE", all=T)
exportCntryType_augm$color[is.na(exportCntryType_augm$color)] <- "lightgray"

#fortify shapefile for ggplot
worldmap_fort<-fortify(worldmap, region="NAME_DE")

# plot map
ggplot() + 
    geom_map(data = exportCntryType_augm, aes(map_id = Land, fill = color), map = worldmap_fort, colour="white", lwd=0.005) + 
    expand_limits(x = worldmap_fort$long, y = worldmap_fort$lat) + 
    coord_equal() +
    labs(title = "In diese Länder hat die Schweiz seit der Jahrtausendwende Waffen exportiert", 
       caption = "In den Jahren 2009 und 2015 importierte auch der Vatikan Kriegsmaterial aus der Schweiz")+
    scale_fill_identity(labels = c(" Im Jahr 2017", "Mindestens einmal im Zeitraum 2000-2016"), breaks=c("blue", "lightblue"), guide = guide_legend(direction="vertical", label.position = "right", keywidth=1, keyheight=.6)) +
    theme(line = element_blank(),
          legend.title = element_blank(),
          plot.title = element_text(),
          plot.caption = element_text(hjust = 0),
          panel.background = element_blank(),
          axis.title=element_blank(),
          axis.text=element_blank(),
          axis.ticks=element_blank(),
          legend.text=element_text())
```

#### KM-Kategorien

Wie verteilt sich das Exportvolumen auf die einzelnen Kategorien? 

```{r export volume categories, fig.height = 7}
# 2000-2017 gesamt 

Kategorie_Summen <- export_restructured  %>% 
   group_by(variable) %>%
   summarize(value = sum(value)) %>% # Exportvolumensummen pro Kategorie berechnen
   arrange(desc(value)) %>% # der Größe nach sortieren
   mutate(variable = factor(variable, levels = variable)) # Kategorie in Faktor konvertieren

# Barplot
valmio_5 <- Kategorie_Summen$value/1000000000
Kategorie_SummenBar <- ggplot(data = Kategorie_Summen, aes(x = variable, y = valmio_5)) + 
   geom_bar(stat = "identity") + 
   geom_text(aes(label = value, vjust=-0.2), size = 3)+
   xlab("Kategorie") +
   scale_y_continuous(name="Exportvolumen in Mrd. CHF", labels=function(x) format(x, big.mark = "'", scientific = FALSE))+
   theme_srf_small()+
   sources_small("SECO", vpos = "top") +
   ggtitle("Exportvolumen pro Kategorie\n2000-2017") +
   theme(axis.text.x = element_text(angle=45, vjust=0.5))
 
Kategorie_SummenBar

# speichern der Grafik als png im Ordner output 
#png(filename = "output/VolumenanteilnachKat.png", width = 624, height = 468)
#Kategorie_SummenBar + theme_srf() + sources("SECO", vpos = "top")
#dev.off()
 
# Anteile der Kategorien an Gesamtvolumen berechnen

gesamt <- sum(Export$value) # Berechnung der Summe aller Exporte 2000-2017

Kategorie_Anteil <- export_restructured  %>% 
   group_by(variable) %>%
   summarize(value = (sum(value)/gesamt)*100) %>% 
   mutate(variable = factor(variable, levels = variable))

Kategorie_Anteil 

# Anteile der Kategorien nach Jahr
KatexportNachJahr <- export_restructured  %>% 
   group_by(Jahr, variable) %>%
   summarize(value = sum(value)) %>%
   mutate(variable = factor(variable))

valmio_6 <- KatexportNachJahr$value/1000000 # Exportvolumen in Millionen
KatexportNachJahrBar <- ggplot(data = KatexportNachJahr, aes(x = Jahr, y = valmio_6, fill = factor(variable), order = variable)) + 
  geom_bar(stat = "identity") + 
   xlab("Jahr") +
   scale_y_continuous(name="Exportvolumen in Mio. CHF", labels=function(x) format(x, big.mark = "'", scientific = FALSE))+
   theme_srf_small()+
   sources_small("SECO", vpos = "top") +
   ggtitle("Exportvolumen nach Jahr\n aufgeschlüsselt nach Kategorie") +
   guides(fill=guide_legend(title="Kategorie", reverse = T))+
   scale_x_continuous(breaks=seq(2000,2016,1),labels=abs(seq(2000,2016,1))) + 
   theme(axis.text.x = element_text(angle=0, vjust=0.5))
   
KatexportNachJahrBar

# Dieselbe Grafik, mit Proportionen
yearMaterialTotal_prop <- export_restructured %>%
  group_by(Jahr, variable) %>%
  summarize("sum_year"=sum(value)) %>%
  mutate("proportion"=100*sum_year/sum(sum_year))

ggplot(yearMaterialTotal_prop, aes(x=Jahr, y=proportion, group=variable, fill=variable))+
  geom_bar(stat="identity") +
  theme(axis.text.x = element_text(angle = 45))+
ggsave("weaponXtime.pdf", width=12)

# speichern der Grafik als png im Ordner output 
#png(filename = "output/VolumenanteilnachKatproJahr.png", width = 624, height = 468)
#KatexportNachJahrBar + theme_srf() + sources("SECO", vpos = "top")
#dev.off()

####### 5 Top Kat
#nach Jahr
Top5_Kat <- export_restructured  %>% 
   group_by(variable) %>%
   summarize(value = sum(value)) %>%
   arrange(desc(value)) %>%
   mutate(variable = factor(variable, levels = variable)) %>%
   slice(1:5)
   
# benenne alle Kategorien, die nicht unter den Top 5 sind in "Andere" und summiere ihre Exportvolummen  
TopKatexportNachJahr <-  KatexportNachJahr %>% 
  mutate(variable = ifelse(variable %in% Top5_Kat$variable, as.character(variable), "Andere")) %>% 
  group_by(Jahr, variable)%>%
  summarize(value = sum(value))
  
# Barchart der Anteile der Kategorien am Gesamtexportvolumen nach Jahr, wobei unter "Andere" alle Kategorien zusammengefasst sind, die nicht unter den Top 5 sind
valmio_7 <- TopKatexportNachJahr$value/1000000
TopKatexportNachJahrBar <- ggplot(data = TopKatexportNachJahr, aes(x = Jahr, y = valmio_7, fill = factor(variable))) + 
  geom_bar(stat = "identity") + 
   xlab("Jahr") +
   scale_y_continuous(name="Exportvolumen in Mio. CHF", labels=function(x) format(x, big.mark = "'", scientific = FALSE))+
   theme_srf_small()+
   sources_small("SECO", vpos = "top") +
   ggtitle("Exportvolumen nach Jahr\n aufgeschlüsselt nach Kategorie") +
   guides(fill=guide_legend(title="Kategorie", reverse = T))+
   scale_x_continuous(breaks=seq(2000,2017,1),labels=abs(seq(2000,2017,1))) + 
   theme(axis.text.x = element_text(angle=0, vjust=0.5))+
   scale_fill_manual(labels = rev(c("Landfahrzeuge", "Munition","Feuerleitgeräte", "Waffen aller Kaliber", "Luftfahrzeuge", "Andere")) , # gebe Kategorien für Legende einen Namen
   values = c( # ordne Farben zu
 "KM6" = "#FFDC00",
 "KM3" = "#FF0C10",
 "KM5" = "#0425B2",
 "KM2" = "#009933",
 "KM10"  = "#33E724",
 "Andere" = "#B7DE00"
  ), drop = F)
   
TopKatexportNachJahrBar

# speichern der Grafik als png im Ordner output 
#png(filename = "output/TopVolumenanteilnachKatproJahr.png", width = 624, height = 468)
#TopKatexportNachJahrBar + theme_srf() + sources("SECO", vpos = "top")+theme(axis.text.x = #element_text(angle=-30, vjust=0.5))
#dev.off()
rm(Export, Kategorie_Anteil, Kategorie_Summen, KatexportNachJahr, TopKatexportNachJahr, TopKatexportNachJahrBar, gesamt, Kategorie_SummenBar, KatexportNachJahrBar, valmio_5, valmio_6, valmio_7)
```

Insgesamt exportierte die Schweiz im Zeitintervall 2000-2017 KM6 (Panzer- und andere Landfahrzeuge; 2 Milliarden) und KM3 (Munition für die in KM 1, 2 oder 12 erfassten Waffen; 2 Milliarden) am meisten. Starker Anstieg von KM10 (Bemannte und unbemannte Luftfahrzeuge inkl. entsprechende Triebwerke) in den Jahren 2011 und 2012, ab 2008 insgesamt mehr aber vor allem KM6. 2013 wieder ungefähr das gleiche Exportvolumen wie 2007, 2014 wieder mehr.

##### Kategorien über Zeit, Liniencharts

 
```{r categories over time}
km_names <- list(
  'KM6'="Landfahrzeuge",
  'KM3'="Munition",
  'KM5'="Feuerleitgeräte",
  'KM2'="Waffen aller Kaliber",
  'KM10'="Luftfahrzeuge"
)
km_labeller <- function(variable, value){
 return(km_names[value])
}
data_for_line_plot <- export_restructured %>% 
  group_by(Jahr, variable) %>% 
  summarize(value = sum(value)) %>% 
  ungroup() %>% 
  filter(variable %in% Top5_Kat$variable) %>% 
  mutate(variable = factor(variable, levels = Top5_Kat$variable))

p <- ggplot(data_for_line_plot, aes(x = Jahr, y = value)) +
  geom_line() +
  facet_grid(variable ~ ., scales = "free_y", labeller = km_labeller) +
  ylab("Exportiertes Volumen") +
  xlab("Jahr") +
  ggtitle("Exportschlager") +
  scale_y_continuous(labels = comma) + 
  theme_minimal()
  # ylim(c(0, max(data_to_plot$pop_year)))
p

rm(data_for_line_plot, km_names, p, Top5_Kat, km_labeller)
```

##### Nur Naher Osten

```{r define middle east countries}
# definiere den nahen Osten 
neareastcountries <- c("Kuwait", "Bahrain", "Oman", "Katar", "Saudi-Arabien", "Vereinigte Arabische Emirate", "Jemen", "Israel", "Jordanien", "Libanon", "Syrien", "Ägypten", "Iran", "Türkei", "Irak")
```

Summe nach Jahr für den nahen Osten

```{r sum per year middle east, fig.height = 8}
OSTexportvolumenNachJahr <- export_restructured  %>% 
   filter(Land %in% neareastcountries) %>% 
   group_by(Jahr, variable) %>%
   summarize(value = sum(value))

# Barchart des Exportvolumens pro Jahr und aufgeschlüsselt nach Kategorien für die Länder des Nahen Ostens 
valmio_8 <- OSTexportvolumenNachJahr$value/1000000
OSTexportvolumenNachJahrBar <- ggplot(data = OSTexportvolumenNachJahr, aes(x = Jahr, y = valmio_8, fill = factor(variable), order = variable)) + 
   geom_bar(stat = "identity") + 
   scale_y_continuous(name="Exportvolumen in Mio. CHF", labels=function(x) format(x, big.mark = "'", scientific = FALSE))+
   scale_x_continuous(breaks=seq(2000,2017,1),labels=abs(seq(2000,2017,1))) + 
   theme_srf_small()+
   sources_small("SECO", vpos = "top") +
   ggtitle("Exportvolumen pro Kategorie \n Naher Osten") +
   guides(fill=guide_legend(title="Kategorie", reverse = T))+
   xlab("Jahr")
   
OSTexportvolumenNachJahrBar

# speichern der Grafik als png im Ordner output 
#png(filename = "output/OstnachJahr.png", width = 624, height = 468)
#OSTexportvolumenNachJahrBar + theme_srf() + sources("SECO", vpos = "top")
#dev.off()
rm(OSTexportvolumenNachJahrBar, valmio_5, valmio_6, valmio_7, valmio_8)
```

Exporte in den Nahen Osten boomen ab 2009, 2011 wurden dann vor allem Güter der Kategorie KM10 (Bemannte und unbemannte Luftfahrzeuge inkl. entsprechende Triebwerke) exportiert, was das grösste Volumen in diesem Jahr massgeblich beeinflusst hat. 2012 wieder leicht weniger KM10, 2013 und 2014 gar nicht mehr und dadurch wieder Werte wie am Boomanfang. 2016 Rückgang von KM4 und KM2, dafür Anstieg von KM5 (Feuerleitgeräte, v.a. Saudi-Arabien)

#### Auswertungen Naher Osten

Wie viel Prozent des Exportvolumens fällt auf den Nahen Osten? 

```{r export volume middle east, fig.height = 8}

# 2000 bis 2017 gesamt
sum(OSTexportvolumenNachJahr$value) #Summe Exportvolumen an den Nahen Osten 2000-2017
sum(OSTexportvolumenNachJahr$value)/sum(export_restructured$value) * 100 #Anteil in Prozent
 
# für jedes Jahr
AnteilOST <- list()
 for(i in 2000:2017){  
AnteilOST[[i]] <- sum(OSTexportvolumenNachJahr[OSTexportvolumenNachJahr$Jahr == i,]$value)/sum(export_restructured[export_restructured$Jahr == i,]$value) * 100  
 }

# Ergebnisse zu übersichtlichem data frame mergen
LAnteilOST <- do.call(rbind.data.frame, AnteilOST[2000:2017]) 
names(LAnteilOST) <- c("Anteil") # Namen der Anteilsspalte ändern
LAnteilOST$Jahr <- 2000:2017 # Zweite Spalte mit Jahreszahlen hinzufügen

LAnteilOST

sum(LAnteilOST[1:9, 1])/length(LAnteilOST[1:9, 1]) # durchschnittlicher Anteil 2000-2008
sum(LAnteilOST[10:13, 1])/length(LAnteilOST[10:13, 1]) # durchschnittlicher Anteil 2009-2012
sum(LAnteilOST[14:16, 1])/length(LAnteilOST[14:16, 1]) # durchschnittlicher Anteil 2013-2016

# Exportvolumen des Nahen Ostens in Vergelich zum Gesamtexportvolumen setzen
# Summe der Exportvolumen des Nahen Ostens gesamt pro Jahr
ExportOST <- export_restructured  %>% 
   filter(Land %in% neareastcountries) %>% 
   group_by(Jahr) %>%
   summarize(value = sum(value))
ExportOST$Länder <- c("Naher Osten")  

# alle Länder, die nicht zum Nahen Osten gehören, unter "Andere" zusammenfassen und ihre Summe der Exportvolumen pro Jahr berechnen
ExportGesoOst <- export_restructured  %>%
   filter(Land %!in% neareastcountries) %>%
   group_by(Jahr) %>%
   summarize(value = sum(value))
ExportGesoOst$Länder <- c("Andere") 

# beide Datensätze zusammenführen
ExportanteilOstforBar <- rbind(ExportGesoOst, ExportOST)

# barplot des Anteils am Gesamtexportvolumen des Nahen Ostens
valmio_10 <- ExportanteilOstforBar$value/1000000
ExportanteilOstBar <- ggplot(data = ExportanteilOstforBar, aes(x = Jahr, y = valmio_10, fill = factor(Länder))) +  
   geom_bar(stat = "identity") + 
   scale_y_continuous(name="Exportvolumen in Mio. CHF", labels=function(x) format(x, big.mark = "'", scientific = FALSE))+
   scale_x_continuous(breaks=seq(2000,2017,1),labels=abs(seq(2000,2017,1))) + 
   theme_srf_small()+
   sources_small("SECO", vpos = "top") +
   ggtitle("Anteil am Gesamtexportvolumen \n Naher Osten") +
   guides(fill=guide_legend(title="Länder", reverse = T))+
   xlab("Jahr")+
   scale_fill_manual(values = c("#0099ff","#fcc000")) 
  
ExportanteilOstBar

# speichern der Grafik als png im Ordner output 
#png(filename = "output/OstanteilanGesamtnachJahr.png", width = 624, height = 468)
#ExportanteilOstBar + theme_srf() + sources("SECO", vpos = "top")+theme(axis.text.x = #element_text(angle=-30, vjust=0.5))
#dev.off()


#Wie hat sich das Exportverhalten der Länder des Nahen Osten pro Jahr verändert?
OST <- export_restructured  %>% 
   filter(Land %in% neareastcountries) %>% 
   group_by(Jahr, Land) %>%
   summarize(value = sum(value))

valmio_11 <- OST$value/1000000
OSTbar <- ggplot(data = OST, aes(x = Jahr, y = valmio_11, fill = Land)) + 
   geom_bar(stat = "identity")+
   scale_y_continuous(name="Exportvolumen in Mio. CHF", labels=function(x) format(x, big.mark = "'", scientific = FALSE))+
   scale_x_continuous(breaks=seq(2000,2016,1),labels=abs(seq(2000,2016,1))) + 
   theme_srf_small()+
   sources_small("SECO", vpos = "top") +
   ggtitle(paste("Exportvolumen nach einzelnen Ländern \n Naher Osten")) +
   guides(fill=guide_legend(title="Länder", reverse = T))+
   xlab("Jahr")
   
OSTbar

# speichern der Grafik als png im Ordner output 
#png(filename = "output/OstnachLandundJahr.png", width = 624, height = 468)
#OSTbar + theme_srf() + sources("SECO", vpos = "top")
#dev.off()

## wie viel Prozent des Exportvolumens an den nahen Osten fällt allein auf die Emirates und Saudi-Arabien?
EmSau <- c("Vereinigte Arabische Emirate", "Saudi-Arabien")
  
  EmSauSumm <- export_restructured  %>% 
   filter(Land %in% EmSau) %>% 
   group_by(Jahr) %>%
   summarize(value = sum(value))
  
sum(EmSauSumm$value)/sum(OST$value)*100

rm(EmSauSumm, EmSau, ExportGesoOst, ExportanteilOstBar, ExportanteilOstforBar, ExportOST, OST, LAnteilOST, i, OSTexportvolumenNachJahr, AnteilOST, OSTbar, valmio_10, valmio_11, neareastcountries)
```

Von den Gesamtexporten von 2000 bis 2016 gingen ca. 13% allein an Länder des nahen Ostens. In LAnteilOST sieht man deutlich, wie der Volumenanteil von durchschnittlich 5% in den Jahren 2009-2012 auf im Schnitt 26% ansteigt und dann von 2013-2016 durchschnittlich wieder auf 7% fällt.
85% aller Exporte, die an Länder des Nahen Ostens gingen, waren für die Vereinigten Arabischen Emirate oder Saudi-Arabien bestimmt. Saudi-Arabien bestellte vor allem 2009 und 2010 Kriegsgüter aus der Schweiz, die Emirate machten 2011 und 2012 den grössten Anteil aus.

#### Nach Kontinenten 

Wie verteilt sich das Exportvolumen auf die Kontinente?

```{r export volume continents, fig.height = 8}

# Reinladen des Excelfiles, das in jeder Spalte die Ländernamen eines anderen Kontinenten beinhaltet
kontinente <- read_excel("input/kontinente.xlsx")

### noch vereinfachen?
  Europa <- export_restructured %>% 
   filter(Land %in% kontinente$Europa) %>% 
   group_by(Jahr) %>%
   summarize(value = sum(value))
  
  Asien <- export_restructured %>% 
   filter(Land %in% kontinente$Asien) %>% 
   group_by(Jahr) %>%
   summarize(value = sum(value))
  
  Mittelamerika <- export_restructured %>% 
   filter(Land %in% kontinente$Mittelamerika) %>%
   group_by(Jahr) %>%
   summarize(value = sum(value))
  
  Afrika <- export_restructured %>% 
   filter(Land %in% kontinente$Afrika) %>%
   group_by(Jahr) %>%
   summarize(value = sum(value))
   
  Nordamerika <- export_restructured %>% 
   filter(Land %in% kontinente$Nordamerika) %>%
   group_by(Jahr) %>%
   summarize(value = sum(value))
    
  Südamerika <- export_restructured %>% 
   filter(Land %in% kontinente$Südamerika) %>%
   group_by(Jahr) %>%
   summarize(value = sum(value))
     
  AustralienOzeanien <- export_restructured %>% 
   filter(Land %in% kontinente$AustralienOzeanien) %>%
   group_by(Jahr) %>%
   summarize(value = sum(value))

regions <- melt(list("Europa" = Europa, "Asien" = Asien, "Mittelamerika" = Mittelamerika,  
                     "Afrika" = Afrika, "Nordamerika" = Nordamerika, "Südamerika" = Südamerika,   
                     "Australien und Ozeanien" = AustralienOzeanien), id.vars = "Jahr")

valmio_13 <- regions$value/1000000
regionvergleich <- ggplot(data = regions, aes(x = Jahr, y = valmio_13, fill = as.factor(L1), order = L1)) + 
   geom_bar(stat = "identity") +
   scale_y_continuous(name="Exportvolumen in Mio. CHF", labels=function(x) format(x, big.mark = "'", scientific = FALSE))+
   scale_x_continuous(breaks=seq(2000,2016,1),labels=abs(seq(2000,2016,1))) + 
   theme_srf_small()+
   sources_small("SECO", vpos = "top") +
   ggtitle("Exportvolumen nach Kontinenten") +
   guides(fill=guide_legend(title="", reverse = T))+
   xlab("Jahr")+
    scale_fill_manual(values = c(
    "Australien und Ozeanien" = "#0425B2",
    "Südamerika" = "#FF8901",
    "Nordamerika" = "#B7DE00",
    "Mittelamerika"  = "#33E724",
    "Afrika" = "#FFDC00",
    "Asien" = "#FF0C10",
    "Europa" = "#009933"
  ), drop = F)+
  theme(axis.text.x = element_text(angle=-30, vjust=0.5))
   
regionvergleich

# speichern der Grafik als png im Ordner output 
#png(filename = "output/VolumennachKontinenten.png", width = 624, height = 468)
#regionvergleich + theme_srf() + sources("SECO", vpos = "top")+theme(axis.text.x = element_text(angle=-30, #vjust=0.5))
#dev.off()
rm(Afrika, Asien, AustralienOzeanien, Europa, Nordamerika, Mittelamerika, regions, Südamerika, kontinente, valmio_13, regionvergleich)
```
Den grössten Anteil am Exportvolumen nehmen europäische Länder ein. Um 2011 herum nehmen Ausfuhren an asiatische Länder zu. Der Rückgang des Exportvolumens von 2015 an ist u.a. dem Rückgang von Auslieferungen an Europa geschuldet. Die Anteile von Asien 2014 bis 2016 dürften zum Grossteil an Indien und Indonesien sowie Pakistan gehen.

##### Waffenexporte in kriegführende Staaten

Exportiert die Schweiz auch Waffen in Länder, die in interne oder internationale Konflikte verwickelt sind? 

```{r}

### READ, CLEAN AND PROCESS CONFLICT DATA ###

# Read uppsala conflict data: state-based dataset, UCDP/PRIO Armed Conflict Dataset version 18.1, cf. http://ucdp.uu.se/downloads/, 
conflictGov_orig<-read.csv("yourname/data/uppsalaCrisisData/state/ucdp-prio-acd-181.csv")

# define dates as dates
conflictGov_orig$start_date2<-as.Date(conflictGov_orig$start_date2, format="%Y-%m-%d")
conflictGov_orig$ep_end_date<-as.Date(conflictGov_orig$ep_end_date, format="%Y-%m-%d")

# if ep_end_date is NA (in 1795 cases), this means that either the conflict continued in the following year (following row) or, if year==2017, that it is possibly still ongoing (next data release: May 2018). leave NA in all the cases where year!=2017, add 2017-12-31 in all the cases where year==2017. Where we leave NA, ggplot2's geom_segment will disregard these rows, which is exactly what we want as these are intermediate stages and not the end of a conflict
conflictGov_orig$ep_end_date[is.na(conflictGov_orig$ep_end_date) & conflictGov_orig$year==2017]<-"2017-12-31"
conflictGov_orig[is.na(conflictGov_orig$ep_end_date),] %>% nrow()

# get rid of conflicts that ended before 2000 as our data does not go back further than that
conflictGov<-conflictGov_orig %>% 
  filter(!ep_end_date<"2000-01-01")

# view different conflict actors. we will keep governments of states only
unique(conflictGov$side_a)
unique(conflictGov$side_b)
unique(conflictGov$side_a_2nd) # sehr weit gefasst, sogar switzerland, im afghanistan-konflikt...sollten aber gucken, dass side_a und side_b immer gleich wie location, sonst ersetzen!
unique(conflictGov$side_b_2nd)



### RENAME COUNTRIES FOR LATER MATCHING THEM WITH CONFLICT DATA ###

# Get German and English country names to match export data (German) with conflict data (English)
codelist_enDe<-data.frame("en"=as.character(codelist$country.name.en), "de"=as.character(codelist$country.name.de))
codelist_enDe$de<-as.character(codelist_enDe$de)

# Create duplicate of dataframe as we will going rename some countries
export_restructured_dup<-export_restructured

# Which levels of Land are not found in our country vector?
export_restructured_dup$Land[which(!(export_restructured_dup$Land %in% codelist_enDe$de))] %>% unique()

# Check how these should be written
codelist_enDe[grep("Poly", codelist_enDe$de),]

# Replace variants in variable "Land" to match codelist
export_restructured_dup$Land[export_restructured_dup$Land == "Grossbritannien"] <- "Großbritannien"
export_restructured_dup$Land[export_restructured_dup$Land == "Hong-Kong"] <- "Hongkong"
export_restructured_dup$Land[export_restructured_dup$Land == "Tschechien"] <- "Tschechische Republik"
export_restructured_dup$Land[export_restructured_dup$Land == "Tschechische Rep."] <- "Tschechische Republik"
export_restructured_dup$Land[export_restructured_dup$Land == "USA"] <- "Vereinigte Staaten"
export_restructured_dup$Land[export_restructured_dup$Land == "Saudi-Arabien"] <- "Saudi Arabien"
export_restructured_dup$Land[export_restructured_dup$Land == "Heiliger Stuhl"] <- "Vatikanstaat"
export_restructured_dup$Land[export_restructured_dup$Land == "Macau"] <- "Macao"
export_restructured_dup$Land[export_restructured_dup$Land == "Russland"] <- "Russische Föderation"
export_restructured_dup$Land[export_restructured_dup$Land == "Südkorea"] <- "Korea, Republik von"
export_restructured_dup$Land[export_restructured_dup$Land == "Brunei"] <- "Brunei Darussalam"
export_restructured_dup$Land[export_restructured_dup$Land == "Suriname"] <- "Surinam"
export_restructured_dup$Land[export_restructured_dup$Land == "Bosnien-Herzegowina"] <- "Bosnien und Herzegowina"
export_restructured_dup$Land[export_restructured_dup$Land == "Kap Verde"] <- "Cabo Verde"
export_restructured_dup$Land[export_restructured_dup$Land == "Trinidad Tobago"] <- "Trinidad und Tobago"
export_restructured_dup$Land[export_restructured_dup$Land == "Französisch-Polynesien"] <- "Französisch Polynesien"

# Join codelist to export data
export_restructured_augm<-export_restructured_dup %>%
  left_join(.,codelist_enDe, by=c("Land"="de"))

# Check if all english names are here
export_restructured_augm[which(is.na(export_restructured_augm$en)),]
data.frame(export_restructured_augm$Land, export_restructured_augm$en)



### PROCESS DATA FRAMES AND COMBINE WEAPON EXPORT DATA WITH CONFLICT DATA ###

# Sometimes several states are primarily involved as well as several supporting co-actors; side_a and side_b are primary actors, side_a_2nd and side_b_2nd secondary/supporting actors in a conflict
conflictGov<-conflictGov %>%
  mutate(side_a_red=gsub("Government of ", "", side_a)) %>%
  mutate(side_b_red=ifelse(grepl("Gov", side_b)==T, paste0(gsub("Government of ", "", side_b)), NA)) %>%
  mutate(side_a_2nd_red=ifelse(grepl("Gov", side_a_2nd)==T, paste0(gsub("Government of ", "", side_a_2nd)), NA)) %>%
  mutate(side_b_2nd_red=ifelse(grepl("Gov", side_b_2nd)==T, paste0(gsub("Government of ", "", side_b_2nd)), NA)) %>%
  mutate(mainSides=ifelse(!is.na(side_b_red), paste(side_a_red, side_b_red, sep=", "),side_a_red)) %>%
  mutate(coSides=ifelse(!is.na(side_a_2nd_red) & !is.na(side_b_2nd_red), paste(side_a_2nd_red, side_b_2nd_red, sep=", "), 
                        ifelse(is.na(side_a_2nd_red) & !is.na(side_b_2nd_red), side_b_2nd_red,
                               ifelse(is.na(side_b_2nd_red) & !is.na(side_a_2nd_red), side_a_2nd_red, NA))))

# Check which levels are not matched in country name vector
conflictGov$mainSides[which(!(conflictGov$mainSides %in% codelist$country.name.en))] %>% unique()
conflictGov$coSides[which(!(conflictGov$coSides %in% codelist$country.name.en))] %>% unique() #15 non-matches,  most of them are groups of countries. we decided to pick russia (in syria, ukraine and georgia) and saudi arabia and the united arab emirates (in yemen) from the side_2nd-parts and not to show the others, as we (NZZ) regard these to be major actors in these conflicts. 

# Replace if spelling different from codelist; check how these should be written
codelist_enDe[grep("Yem", codelist_enDe$en),]

# Replace Land to match codelist, primary actors
conflictGov$mainSides<-as.character(conflictGov$mainSides)
conflictGov$mainSides[conflictGov$mainSides == "Yemen (North Yemen)"|conflictGov$mainSides == "South Yemen"] <- "Yemen"
conflictGov$mainSides[conflictGov$mainSides == "Cambodia (Kampuchea)"] <- "Cambodia"
conflictGov$mainSides[conflictGov$mainSides == "Russia (Soviet Union)"] <- "Russia"
conflictGov$mainSides[conflictGov$mainSides == "Serbia (Yugoslavia)"] <- "Serbia"
conflictGov$mainSides[conflictGov$mainSides == "Macedonia, FYR"] <- "Macedonia"
conflictGov$mainSides[conflictGov$mainSides == "Trinidad and Tobago"] <- "Trinidad & Tobago"
conflictGov$mainSides[conflictGov$mainSides == "Congo"] <- "Congo - Brazzaville"
conflictGov$mainSides[conflictGov$mainSides == "DR Congo (Zaire)"] <- "Congo - Kinshasa"
conflictGov$mainSides[conflictGov$mainSides == "United States of America"] <- "United States"
conflictGov$mainSides[conflictGov$mainSides == "Bosnia-Herzegovina"] <- "Bosnia & Herzegovina"
conflictGov$mainSides[conflictGov$mainSides == "Ivory Coast"] <- "Côte d’Ivoire"
conflictGov$mainSides[conflictGov$mainSides == "Zimbabwe (Rhodesia)"] <- "Zimbabwe"
conflictGov$mainSides[conflictGov$mainSides == "South Vietnam"|conflictGov$mainSides == "Vietnam (North Vietnam)"|conflictGov$mainSides == "South Vietnam, Vietnam (North Vietnam)"] <- "Vietnam"
# secondary actors
conflictGov$coSides<-as.character(conflictGov$coSides)
conflictGov$coSides[conflictGov$coSides == "Yemen (North Yemen)"|conflictGov$coSides == "South Yemen"] <- "Yemen"
conflictGov$coSides[conflictGov$coSides == "Cambodia (Kampuchea)"] <- "Cambodia"
conflictGov$coSides[conflictGov$coSides == "Russia (Soviet Union)"] <- "Russia"
conflictGov$coSides[conflictGov$coSides == "Serbia (Yugoslavia)"] <- "Serbia"
conflictGov$coSides[conflictGov$coSides == "Macedonia, FYR"] <- "Macedonia"
conflictGov$coSides[conflictGov$coSides == "Trinidad and Tobago"] <- "Trinidad & Tobago"
conflictGov$coSides[conflictGov$coSides == "Congo"] <- "Congo - Brazzaville"
conflictGov$coSides[conflictGov$coSides == "DR Congo (Zaire)"] <- "Congo - Kinshasa"
conflictGov$coSides[conflictGov$coSides == "United States of America"] <- "United States"
conflictGov$coSides[conflictGov$coSides == "Bosnia-Herzegovina"] <- "Bosnia & Herzegovina"
conflictGov$coSides[conflictGov$coSides == "Ivory Coast"] <- "Côte d’Ivoire"
conflictGov$coSides[conflictGov$coSides == "Zimbabwe (Rhodesia)"] <- "Zimbabwe"
conflictGov$coSides[conflictGov$coSides == "South Vietnam"|conflictGov$coSides == "Vietnam (North Vietnam)"|conflictGov$coSides == "South Vietnam, Vietnam (North Vietnam)"] <- "Vietnam"


# When there are several actors on one side, duplicate all the according rows and make country name unique (e.g. entries for india, entries for pakistan, in the case of location=="India, Pakistan")
# Strategy: create new dataframe with duplicate, replace country name, replace country name in original data frame, rbind

# Which levels are not matched yet?
conflictGov$mainSides[which(!(conflictGov$mainSides %in% codelist$country.name.en))] %>% unique()
conflictGov$coSides[which(!(conflictGov$coSides %in% codelist$country.name.en))] %>% unique()

codelist_enDe[grep("Mor", codelist_enDe$en),]

# India, Pakistan
indpak<-conflictGov[conflictGov$mainSides == "India, Pakistan",]
indpak$mainSides<-"Pakistan"
conflictGov$mainSides[conflictGov$mainSides == "India, Pakistan"]<-"India"
conflictGov<-rbind(conflictGov,indpak)

# Cambodia (Kampuchea), Thailand
camtha<-conflictGov[conflictGov$mainSides == "Cambodia (Kampuchea), Thailand",]
camtha$mainSides<-"Thailand"
conflictGov$mainSides[conflictGov$mainSides == "Cambodia (Kampuchea), Thailand"]<-"Cambodia"
conflictGov<-rbind(conflictGov,camtha)

# Eritrea, Ethiopia
erieth<-conflictGov[conflictGov$mainSides == "Eritrea, Ethiopia",]
erieth$mainSides<-"Ethiopia"
conflictGov$mainSides[conflictGov$mainSides == "Eritrea, Ethiopia"]<-"Eritrea"
conflictGov<-rbind(conflictGov,erieth)

# South Sudan, Sudan
sousud<-conflictGov[conflictGov$mainSides == "South Sudan, Sudan",]
sousud$mainSides<-"Sudan"
conflictGov$mainSides[conflictGov$mainSides == "South Sudan, Sudan"]<-"South Sudan"
conflictGov<-rbind(conflictGov,sousud)

# Djibouti, Eritrea
djieri<-conflictGov[conflictGov$mainSides == "Djibouti, Eritrea",]
djieri$mainSides<-"Eritrea"
conflictGov$mainSides[conflictGov$mainSides == "Djibouti, Eritrea"]<-"Djibouti"
conflictGov<-rbind(conflictGov,djieri)

# Afghanistan, United Kingdom, United States of America
afgkin<-conflictGov[conflictGov$mainSides == "Afghanistan, United Kingdom, United States of America",]
afgame<-conflictGov[conflictGov$mainSides == "Afghanistan, United Kingdom, United States of America",]
afgkin$mainSides<-"United Kingdom"
afgame$mainSides<-"United States"
conflictGov$mainSides[conflictGov$mainSides == "Afghanistan, United Kingdom, United States of America"]<-"Afghanistan"
conflictGov<-rbind(conflictGov,afgkin, afgame)

# Australia, United Kingdom, United States of America, Iraq
ausira<-conflictGov[conflictGov$mainSides == "Australia, United Kingdom, United States of America, Iraq",]
auskin<-conflictGov[conflictGov$mainSides == "Australia, United Kingdom, United States of America, Iraq",]
ausame<-conflictGov[conflictGov$mainSides == "Australia, United Kingdom, United States of America, Iraq",]
ausira$mainSides<-"Iraq"
auskin$mainSides<-"United Kingdom"
ausame$mainSides<-"United States"
conflictGov$mainSides[conflictGov$mainSides == "Australia, United Kingdom, United States of America, Iraq"]<-"Australia"
conflictGov<-rbind(conflictGov,ausira, auskin, ausame)

# As stated above, we will add several secondary actors and treat them as if they were main actors (rationale: see article, https://www.nzz.ch/ld.1422907).
# Get detailed date information from in conflictGov_orig, on saudi arabia and united arab emirates (yemen) and russia (syria, ukraine, georgia).
# Start and end date are not always equal to those of the general conflict, as some secondary actors started supporting a primary actor after a conflict had been going on for a while
# Add names, dates. If the data only provide date information at the year-level, we assume the conflict to have started on January 1st and ended on December 31st
conflictGov_orig[grep("Saudi", conflictGov_orig$side_a_2nd),] # Saudi arabia was part of the US-lead conflict against al-Qaida in 2004-2007 (with Afghanistan, Pakistan, UK), and against the "IS" in Irak in 2014-2017 (with 12 other states)
conflictGov_orig[grep("Saudi", conflictGov_orig$side_b_2nd),] # Saudi arabia fought against Kuwait on Iraq's side in 1991 along with many others, and was active in Yemen from 2015-2017 (with Bahrain, Egypt, Jordan, Kuwait, Morocco, Qatar, Sudan, Emirates, but as a leader of this coalition)
conflictGov_orig[grep("Emira", conflictGov_orig$side_a_2nd),] # The Emirates were part of conflicts in Afghanistan and Irak against the "IS" and the Taleban, along with many other countries 
conflictGov_orig[grep("Emira", conflictGov_orig$side_b_2nd),] # The Emirates are part of the Yemen conflict, along with Saudiarabia, Bahriain, Egypt, Jordan, Kuwait, Morocco, Qatar, Sudan.
conflictGov_orig[grep("Russ", conflictGov_orig$side_a_2nd),] # Russia is part of conflicts in Syria , with Iran, 2015-2017, against Syrian insurgents and IS", together with Syrian Government as a primary actor
conflictGov_orig[grep("Russ", conflictGov_orig$side_b_2nd),] # Ukraine (2014-2017), Georgia (2008)

# Saudi arabia: conflict_id 230 | Emirates: conflict_id 230 | Russia: 299, 13604 (Syria), 13246, 13247, 13306 (Ukraine)
conflictGov_coSides<-conflictGov[conflictGov$conflict_id %in% c(230, 299, 393, 13604, 13246, 13247, 13306),] #build rest from this and from grep saudi in conflictGov_orig
emirates<-conflictGov[conflictGov$conflict_id %in% c(230),]
emirates$mainSides<-"United Arab Emirates"
conflictGov_coSides<-rbind(conflictGov_coSides, emirates)
conflictGov_coSides[conflictGov_coSides$mainSides=="Yemen",]$mainSides<-"Saudi Arabia"
conflictGov_coSides[conflictGov_coSides$mainSides=="Ukraine" | conflictGov_coSides$mainSides=="Syria",]$mainSides<-"Russia"
conflictGov_coSides<-conflictGov_coSides[-which(conflictGov_coSides$mainSides=="Georgia" & conflictGov_coSides$year==2004),] # get rid of the part of the Georgia-conflict that did not involve Russia
conflictGov_coSides[conflictGov_coSides$mainSides=="Georgia",]$mainSides<-"Russia" # get rid of the part of the Georgia-conflict that did not involve Russia

# Adapt dates: start and end year: sideb2nd was not necessarily part for the entire time of the conflict, e.g. saudi arabia in yemen (conflict 230 has been going for longer).
conflictGov_coSides[conflictGov_coSides$mainSides %in% c("Saudi Arabia", "United Arab Emirates"),]$start_date2<-"2015-01-01"
conflictGov_coSides[conflictGov_coSides$mainSides %in% c("Saudi Arabia", "United Arab Emirates"),]$ep_end_date<-"2017-12-31"
conflictGov_coSides[conflictGov_coSides$conflict_id==299,]$start_date2<-"2015-01-01"
conflictGov_coSides[conflictGov_coSides$conflict_id==299,]$ep_end_date<-"2017-12-31"
conflictGov_coSides[conflictGov_coSides$conflict_id==393,]$start_date2<-"2008-08-08" # as this was a short war, detailed dates were added
conflictGov_coSides[conflictGov_coSides$conflict_id==393,]$ep_end_date<-"2008-08-16"
conflictGov_coSides[conflictGov_coSides$conflict_id==13604,]$start_date2<-"2015-01-01"
conflictGov_coSides[conflictGov_coSides$conflict_id==13604,]$start_date2<-"2015-01-01"
conflictGov_coSides[conflictGov_coSides$conflict_id==13246,] #already has the correct dates
conflictGov_coSides[conflictGov_coSides$conflict_id==13247,] #already has the correct dates
conflictGov_coSides[conflictGov_coSides$conflict_id==13306,] #already has the correct dates

# Bind to conflictGov
conflictGov<-rbind(conflictGov, conflictGov_coSides)

# Add columns with start year and end year
conflictGov<-conflictGov %>%
  mutate("start_year"=substr(start_date2, 1, 4), "end_year"=substr(ep_end_date, 1, 4))

# Add column where we adapt the start date to 2000-01-01 whenever a conflict started before that - as we are not able to show export data further back than 2000, and this is a step used for visualising the data with ggplot2
conflictGov<-conflictGov %>% 
  mutate("start_date3"=ifelse(start_date2<="2000-01-01", "2000-01-01", as.character(start_date2)))
conflictGov$start_date3<-as.Date(conflictGov$start_date3, format="%Y-%m-%d")

# Visualize conflicts
conflictGov$mainSides<-as.factor(conflictGov$mainSides)
ggplot(conflictGov)+#conflictGov_export_adapt
  geom_segment(aes(x=start_date2, xend=ep_end_date, y=mainSides, yend=mainSides, group=mainSides))
ggsave("conflict.pdf", height=12)

# subset confclit data by those countries that Switzerland exports weaopns to
conflictGov$mainSides[which((conflictGov$mainSides %in% export_restructured_augm$en))] %>% unique()
conflictGov_export<-conflictGov[which((conflictGov$mainSides %in% export_restructured_augm$en)),]
unique(conflictGov_export$mainSides)


## There are also one-sided conflicts where the Government of a country used arms against the population. Read and process these data ##
conflictOne<-read.csv("yourpath/data/uppsalaCrisisData/oneSided/ucdp-onesided-181.csv")
conflictOne<-conflictOne[grep("Government", conflictOne$actor_name_fulltext),] # get those conflicts that stem from the Government
conflictOne<-conflictOne %>% 
  filter(year>=2000)

# Check, by hand, if the actor is always the same government as stated in the column location
data.frame(conflictOne$actor_name, conflictOne$location)

# Adapt one instance:
conflictOne$mainSides<-conflictOne$location
conflictOne$mainSides[conflictOne$actor_name == "Government of Uganda"& conflictOne$year==2000]<-"Uganda"

# Check which of the conflict country names do not appear in the codelist english country names
conflictOne$mainSides[which(!(conflictOne$mainSides %in% codelist$country.name.en))] %>% unique()

# Replace if different spelling; check spelling
codelist_enDe[grep("Myan", codelist_enDe$en),]

# Replace elements of column "Land" to match codelist
conflictOne$mainSides<-as.character(conflictOne$mainSides)
conflictOne$mainSides[conflictOne$mainSides == "Yemen (North Yemen)"|conflictOne$mainSides == "South Yemen"] <- "Yemen"
conflictOne$mainSides[conflictOne$mainSides == "Russia (Soviet Union)"] <- "Russia"
conflictOne$mainSides[conflictOne$mainSides == "DR Congo (Zaire)"] <- "Congo - Kinshasa"
conflictOne$mainSides[conflictOne$mainSides == "Zimbabwe (Rhodesia)"] <- "Zimbabwe"
conflictOne$mainSides[conflictOne$mainSides == "Ivory Coast"] <- "Côte d’Ivoire"
conflictOne$mainSides[conflictOne$mainSides == "Madagascar (Malagasy)"] <- "Madagascar"

# When there are two Governments: Which government is the actor? Check and only include this country
conflictOne$mainSides[conflictOne$mainSides == "Central African Republic, Chad"] <- "Central African Republic"
conflictOne$mainSides[conflictOne$mainSides == "DR Congo (Zaire), Uganda"] <- "Congo - Kinshasa"
conflictOne$mainSides[conflictOne$mainSides == "Burundi, Tanzania"] <- "Burundi"
conflictOne$mainSides[conflictOne$mainSides == "DR Congo (Zaire), Rwanda"] <- "Rwanda"
conflictOne$mainSides[conflictOne$mainSides == "Ethiopia, Sudan"] <- "Ethiopia"
conflictOne$mainSides[conflictOne$mainSides == "Ethiopia, Somalia"] <- "Ethiopia"
conflictOne$mainSides[conflictOne$mainSides == "Chad, Sudan"] <- "Sudan"
conflictOne$mainSides[conflictOne$mainSides == "South Sudan, Sudan"] <- "Sudan"
conflictOne$mainSides[conflictOne$mainSides == "Lebanon, Syria"] <- "Syria"
conflictOne$mainSides[conflictOne$mainSides == "Israel, Lebanon"] <- "Israel"
conflictOne$mainSides[conflictOne$mainSides == "Bangladesh, Myanmar (Burma)"] <- "Myanmar (Burma)"

# Subset dataframe by those countries that are in the export countries
conflictOne$mainSides[which((conflictOne$mainSides %in% export_restructured_augm$en))] %>% unique()
conflictOne_export<-conflictOne[which((conflictOne$mainSides %in% export_restructured_augm$en)),]

# Compare structures of the two confict data frames and adapt their respective structures in order to be able to bind those data frames together
str(conflictOne)
str(conflictGov)

conflictOne_export_adapt<-conflictOne_export %>% 
  mutate("conflict_id"=conflict_id, "start_year"=year, "end_year"=year, "start_date2"=paste0(year, "-01-01"), "start_date3"=paste0(year, "-01-01"), "ep_end_date"=paste0(year,"-12-31"), "side_a"=actor_name, "side_b"="none", "mainSides"=mainSides) %>%
  select(conflict_id, location, mainSides, side_a, side_b, year, start_date2, start_date3, ep_end_date, start_year, end_year)

conflictGov_export_adapt<-conflictGov_export %>%
  select(conflict_id, location, mainSides, side_a, side_b, year, start_date2, start_date3, ep_end_date, start_year, end_year)

summary(conflictGov_export_adapt)
summary(conflictOne_export_adapt)

conflict_export<-rbind(conflictGov_export_adapt,conflictOne_export_adapt)

# Find countries that were in conflict as well as exported weapons to from 2000 on
intersect(conflict_export$mainSides, export_restructured_augm$en)

# Now find countries that were in conflict *in same year* as weapon exports happened

# For this, first summarize export data in order to get one value per year (pool over weapon type variable)
countryXtime_augm<-export_restructured_augm %>%
  group_by(Land, en, Jahr) %>%
  summarize(value = sum(value)) %>%
  arrange(Land,en, Jahr)

# Merge the conflict and the weapon export data using the English codelist column
conflict_export_merged<-conflict_export %>%
  left_join(.,countryXtime_augm, by=c("mainSides"="en"))

# How many countries were sold weapons in years where they were in conflict?
cntries_export_conflict_sametime<-conflict_export_merged %>%
  filter(!is.na(conflict_export_merged$Land)) %>%
  filter(value!=0 & Jahr >= start_year & Jahr <= end_year)
unique(cntries_export_conflict_sametime$Land)



### RESULTS AND VISUALIZATION ###

# To find out how weapon exports to conflict parties developed over time, we need unique country-year-combinations
cntries_export_conflict_sametime
conflictGov_export_conflictCntryTime_red<-cntries_export_conflict_sametime %>%
  group_by(Land, Jahr)%>%
  slice(1L)%>%
  arrange(Land, Jahr)

conflictGov_export_conflictCntryTime_red$Land%>%unique() # check number of states
conflictGov_export_conflictCntryTime_red

# How many years did we export arms to a country that was in conflict at the same time?
article_table<-conflictGov_export_conflictCntryTime_red %>%
  group_by(Land) %>%
  summarise(nYears=n()) %>%
  arrange(desc(nYears))

# And how much did we export to such countries, per year?
exportvolumeXconflictYearCountry<-conflictGov_export_conflictCntryTime_red %>%
  group_by(Land)%>%
  summarize(totalExportVolume=sum(value))%>%
  arrange(desc(totalExportVolume))

ggplot(conflictGov_export_conflictCntryTime_red, aes(x=Jahr, y=value))+
  geom_bar(stat="identity")

ggplot(conflictGov_export_conflictCntryTime_red, aes(x=Jahr, y=value, fill=Land))+
  geom_bar(stat="identity")

# Write absolute numbers
article<-cntries_export_conflict_sametime %>%
  group_by(Land, Jahr)%>%
  slice(1L)%>%
  group_by(Jahr)%>%
  summarise(total=sum(value))%>%
  arrange(Jahr)
write.table(article, file="yourpath/data/output/exportWhileConflict_cntries.txt", sep="\t", row.names=F, quote=F)

# Write numbers relative to total weapon exports
export_conflictVsAll<-data.frame(article, Export)
export_conflictVsAll_rel<-export_conflictVsAll %>%
  mutate(proportion=100*total/value)
export_conflictVsAll_rel
write.table(export_conflictVsAll_rel, file="yourpath/data/exportWhileConflict_cntries_prop.txt", sep="\t", row.names=F, quote=F)

# Write numbers relative to total weapon exports, by country, for the 5 countries where Switzerland exported weapons during conflicts during the most years
countries<-c("Vereinigte Staaten", "Pakistan", "Indien", "Thailand", "Türkei")
export_conflictCntriesVsAll_selection<-conflictGov_export_conflictCntryTime_red %>%
  left_join(Export[-19,], by=("Jahr"="Jahr")) %>%
  mutate(proportion=100*value.x/value.y)%>%
  filter(Land %in% countries)%>%
  select(Jahr, Land, proportion)

export_conflictCntriesVsAll_andere <- conflictGov_export_conflictCntryTime_red %>%
  left_join(Export[-19,], by=("Jahr"="Jahr")) %>%
  filter(!Land %in% countries) %>%
  group_by(Jahr, value.y) %>%
  summarize(value = sum(value.x)) %>%
  mutate(proportion=100*value/value.y, Land="Andere")%>%
  select(Jahr, Land, proportion)

# Bind countries and others, reshape and write
export_conflictCntriesVsAll_article<-rbind(export_conflictCntriesVsAll_selection, export_conflictCntriesVsAll_andere)
export_conflictCntriesVsAll_article_wide<-export_conflictCntriesVsAll_article %>%
  spread(Land, proportion)
export_conflictCntriesVsAll_article_wide[is.na(export_conflictCntriesVsAll_article_wide)] <- 0
write.table(export_conflictCntriesVsAll_article_wide, file="yourpath/data/exportWhileConflict_cntries_prop_byCountry.txt", sep="\t", row.names=F, quote=F)

# Merge number of years and export volume per country for table in article
article_table_augm<-merge(exportvolumeXconflictYearCountry, article_table, by.x="Land", by.y="Land") %>%
  arrange(desc(nYears))
write.table(article_table_augm, file="yourpath/data/exportWhileConflict_YearXCntry.txt", sep="\t", row.names=F,quote=F, fileEncoding = "UTF-8")

## Small multiples of export volume and conflict ##

# Augment the export data with more pseudo-detailed date indication for ggplot to accept it
countryXtime_augm$Jahr_augm<-rep(1,nrow(countryXtime_augm))

# Set July 1st as mid-point of the bar
for (i in 1:nrow(countryXtime_augm)) countryXtime_augm$Jahr_augm[i]<-paste(countryXtime_augm$Jahr[i],"07","01",sep="-")
countryXtime_augm$Jahr_augm<-as.Date(countryXtime_augm$Jahr_augm, format="%Y-%m-%d")

# Subset countryXtime_augm to keep only those countries that were in a conflict sometime from 2000 on
countryXtime_augm_conflict<-countryXtime_augm[countryXtime_augm$Land %in% cntries_export_conflict_sametime$Land,]
conflict_export_red<-conflict_export_merged[conflict_export_merged$Land %in% cntries_export_conflict_sametime$Land,]

# Relevel for order of facets
countryXtime_augm_conflict$Land_neu = factor(countryXtime_augm_conflict$Land, levels=c('Vereinigte Staaten','Türkei','Indien','Pakistan', 'Thailand', 'Russische Föderation', 'Israel', 'Philippinen', 'Indonesien', 'Kenia', 'Libanon', 'Mali', 'Saudi Arabien', 'Sudan', 'Vereinigte Arabische Emirate', 'Elfenbeinküste', 'Großbritannien', 'Guinea', 'Niger', 'Ägypten', 'Algerien', 'Australien', 'Bahrain', 'Bangladesch', 'Brasilien', 'Jordanien', 'Kolumbien', 'Malaysia', 'Tunesien', 'Uganda', 'Ukraine', 'Venezuela'))
conflict_export_red$Land_neu = factor(conflict_export_red$Land, levels=c('Vereinigte Staaten','Türkei','Indien','Pakistan', 'Thailand', 'Russische Föderation', 'Israel', 'Philippinen', 'Indonesien', 'Kenia', 'Libanon', 'Mali', 'Saudi Arabien', 'Sudan', 'Vereinigte Arabische Emirate', 'Elfenbeinküste', 'Großbritannien', 'Guinea', 'Niger', 'Ägypten', 'Algerien', 'Australien', 'Bahrain', 'Bangladesch', 'Brasilien', 'Jordanien', 'Kolumbien', 'Malaysia', 'Tunesien', 'Uganda', 'Ukraine', 'Venezuela'))

# Plot small multiples
ggplot(countryXtime_augm_conflict, aes(x=Jahr_augm, y=value))+
  geom_segment(data=conflict_export_red, aes(x=start_date3, xend=ep_end_date, y=125000000, yend=125000000, col="darkgray"))+ #use start_date3, here, as a trick to show all the data!
  geom_bar(stat="identity") + 
  facet_wrap(~Land_neu)+
  scale_x_date(breaks=as.Date(c("2000-01-01","2017-12-31")),labels=c("2000", "2017"),
               limits = as.Date(c('2000-01-01','2017-12-31')))+
  scale_y_continuous(breaks=c(0, 60000000, 120000000), labels=c("0", "60000000", "120000000"))+
  theme_minimal()+
  theme(axis.text.x=element_text(family="GT America", color="#05032d", size=11),
        axis.text.y=element_text(family="GT America", color="#05032d", size=11),
        legend.position="none",
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank())
ggsave("conflict_export.svg", width=12)
ggsave("conflict_export.pdf", width=12)

#now just plot the export with free scales
ggplot(countryXtime_augm_conflict, aes(x=Jahr_augm, y=value))+
  geom_segment(data=conflict_export_red, aes(x=start_date3, xend=ep_end_date, y=2, yend=2, col="darkgray"))+
  geom_bar(stat="identity") + 
  facet_wrap(~Land_neu, scales="free_y")+
  scale_x_date(breaks=as.Date(c("2000-01-01","2017-12-31")),labels=c("2000", "2017"),
               limits = as.Date(c('2000-01-01','2017-12-31')))+
  theme_minimal()+
  theme(axis.text.x=element_text(family="GT America", color="#05032d", size=11),
        axis.text.y=element_text(family="GT America", color="#05032d", size=11),
        legend.position="none",
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank())
ggsave("conflict_export_freeY_V2.svg", width=12)
ggsave("conflict_export_freeY_V2.pdf", width=12)

# Plot small multiples with flexible Y-axis
countries<-c("Vereinigte Arabische Emirate", "Saudi Arabien", "Indien", "Pakistan", "Russische Föderation", "Thailand", "Türkei", "Vereinigte Staaten")
for (i in countries){
  countryi<-subset(countryXtime_augm_conflict, countryXtime_augm_conflict$Land_neu==i)
  countryi_conflicti<-subset(conflict_export_red,conflict_export_red$Land_neu==i)
  ggplot(countryi, aes(x=Jahr_augm, y=value))+
    geom_segment(data=countryi_conflicti, aes(x=start_date3, xend=ep_end_date, y=2, yend=2, col="darkgray"))+
    geom_bar(stat="identity") + 
    facet_wrap(~Land_neu, scales="free_y")+
    #scale_x_date(breaks=as.Date(c("2000-01-01","2017-12-31")),labels=c("2000", "2017"),
    #              limits = as.Date(c('2000-01-01','2017-12-31')))+
    theme_minimal()+
    theme(axis.text.x=element_text(family="GT America", color="#05032d", size=11),
          axis.text.y=element_text(family="GT America", color="#05032d", size=11),
          legend.position="none",
          axis.title.x=element_blank(),
          axis.title.y=element_blank(),
          panel.grid.minor.x = element_blank(),
          panel.grid.minor.y = element_blank())
  ggsave(paste0("conflict_exportXtime_cntry_selection", "_", i, ".svg"), width=12)
}

# Plot only India and Pakistan side by side
countryXtime_augm_conflict_indiaPakistan<-countryXtime_augm_conflict[countryXtime_augm_conflict$Land_neu %in% c("Indien", "Pakistan"),]
conflict_export_red_indiaPakistan<-conflict_export_red[conflict_export_red$Land_neu %in% c("Indien", "Pakistan"),]

ggplot(countryXtime_augm_conflict_indiaPakistan, aes(x=Jahr_augm, y=value))+
  geom_segment(data=conflict_export_red_indiaPakistan, aes(x=start_date3, xend=ep_end_date, y=125000000, yend=125000000, col="darkgray"))+ #use start_date3, here, as a trick to show all the data!
  geom_bar(stat="identity") + 
  facet_wrap(~Land_neu)+
  scale_x_date(breaks=as.Date(c("2000-01-01","2017-12-31")),labels=c("2000", "2017"),
               limits = as.Date(c('2000-01-01','2017-12-31')))+
  scale_y_continuous(breaks=c(0, 50000000, 100000000), labels=c("0", "50000000", "100000000"))+
  theme_minimal()+
  theme(axis.text.x=element_text(family="GT America", color="#05032d", size=11),
        axis.text.y=element_text(family="GT America", color="#05032d", size=11),
        legend.position="none",
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank())
ggsave("conflict_export_indienPakistan.svg", width=12)
ggsave("conflict_export_indienPakistan.pdf", width=12)

# Visualize each and every conflict for each of those countries
countries<-c("Vereinigte Arabische Emirate", "Saudi Arabien", "Indien", "Pakistan", "Russische Föderation", "Thailand", "Türkei", "Vereinigte Staaten")
for (i in countries){
  countryi_conflicti<-subset(conflict_export_red,conflict_export_red$Land_neu==i)
  ggplot(countryi_conflicti, aes(x=Jahr_augm))+
    geom_segment(data=countryi_conflicti, aes(x=start_date3, xend=ep_end_date, y=2, yend=2, col="darkgray"))+
    facet_wrap(~conflict_id, scales="free_y")+
    theme_minimal()+
    theme(axis.text.x=element_text(family="GT America", color="#05032d", size=11),
          axis.text.y=element_text(family="GT America", color="#05032d", size=11),
          legend.position="none",
          axis.title.x=element_blank(),
          axis.title.y=element_blank(),
          panel.grid.minor.x = element_blank(),
          panel.grid.minor.y = element_blank())
  ggsave(paste0("conflictXtime_cntry_selection", "_", i, ".png"), width=12)
}



### VISUALIZE WHICH WEAPON TYPES WERE EXPORTED IN WHICH YEARS ###

# recategorize weapon types
export_restructured_recoded<-export_restructured
export_restructured_recoded$variable <-recode(export_restructured$variable, "KM1"="KM2") #waffen jeglichen kalibers, inkl Hand- und Faustfeuerwaffen
export_restructured_recoded$variable <-recode(export_restructured_recoded$variable, "KM4"="Andere") 
export_restructured_recoded$variable <-recode(export_restructured_recoded$variable, "KM7"="Andere")
export_restructured_recoded$variable <-recode(export_restructured_recoded$variable, "KM8"="Andere")
export_restructured_recoded$variable <-recode(export_restructured_recoded$variable, "KM16"="Andere")
summary(as.factor(export_restructured_recoded$variable))

export_restructured_recoded %>%
  group_by(variable)%>%
  summarize(value=sum(value))%>%
  arrange(value)

# Calculate proportions
cntryMaterial_prop <- export_restructured_recoded %>%
  group_by(Land, Jahr, variable) %>%
  summarize(value=sum(value)) %>%
  group_by(Land, Jahr) %>%
  mutate("sum" = sum(value)) %>%
  group_by(variable) %>%
  mutate("proportion"=100*value/sum)

countries<-c("Indien", "Saudi-Arabien", "Vereinigte Arabische Emirate", "Pakistan", "Russland", "Thailand", "Türkei", "USA")
weapondata_article<-cntryMaterial_prop %>% 
  select(Jahr, Land, variable, proportion)%>%
  spread(variable, proportion)%>%
  arrange(Land, Jahr) %>%
  select(Land, Jahr, KM2, KM3, KM6, KM10, KM5, Andere) %>%
  rename(`Waffen`=KM2, Munition=KM3, Panzer=KM6, Feuerleiteinrichtungen=KM5, Luftfahrzeuge=KM10)

# Plot for each country
for (i in countries){
  countryi<-subset(weapondata_article, weapondata_article$Land==i)
  ggplot(gather(countryi, key=variable, value=proportion, Waffen:Andere), aes(x=Jahr, y=proportion, group=variable, fill=variable))+
    geom_bar(stat="identity", width=.9)+
    scale_x_discrete(name="Jahr", breaks=c(2000,2017), labels=c("2000", "2017"), limits=c(2000, 2017))+
    theme_minimal()+
    ggsave(paste0("weaponXtime_cntry_selection", "_", i, ".svg"), width=12)
}

# Write the data, too
for (i in countries){
  countryi<-subset(weapondata_article, weapondata_article$Land==i)
  write.table(countryi, file=paste0("yourpath/data/weapontXtime_8conflictCntries_", i, ".txt"), sep="\t", row.names=F, quote=F)
}

```







